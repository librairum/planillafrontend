<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<p-dialog header="Detalle Plantilla"
[(visible)]="showDetalleModal"
[modal]="true"
[style]="{width: '600px'}"
(onHide)="closeDetalle()"
[draggable]="false">
  <ng-template pTemplate="header">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <span>Detalle de Plantilla: {{ selectedPlantilla?.pla20descripcion }}</span>
      <!--<button pButton icon="pi pi-times" (click)="closeDetalle()" class="p-button-text"></button>-->
    </div>
  </ng-template>

  <p-table [value]="plantillaDetalleList" [paginator]="false">
    <ng-template pTemplate="header">
      <tr>
        <th>Columna</th>
        <th>Alias</th>
        <th style="text-align: center;">Estado</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-det let-i="rowIndex">
      <tr>
        <td>{{ det.pla21camponombre }}</td>
        <td>{{ det.pla21campoalias }}</td>
        <td style="text-align: center;">
          <p-checkbox
            [binary]="true"
            [(ngModel)]="det.estado"
            [trueValue]="1"
            [falseValue]="0"
          ></p-checkbox>
        </td>
      </tr>
    </ng-template>
  </p-table>
  <div class="flex justify-content-end mt-3">
    <button pButton type="button" label="Guardar cambios" icon="pi pi-save"
      (click)="guardarEstadosDetalle()" class="p-button-success p-button-sm"></button>
  </div>
</p-dialog>

<div class="container">
  <p-panel header ="Mantenimiento de plantilla" class="mb-3"></p-panel>
  <br>

  <div class="card">

    <div class="flex justify-content-between align-items-center mb-3">
            <button type="button" pButton icon="pi pi-plus" label="Nueva Plantilla"
                    (click)="showAddRow()" [disabled]="isEditingAnyRow"
                    class="p-button-sm"></button>
            <div class="flex align-items-center">
                <label for="rowsPerPage" class="mr-2">Filas por página:</label>
                <p-dropdown id="rowsPerPage" [options]="[10, 20, 40]" [(ngModel)]="rowsPerPage" placeholder="Seleccionar" class="p-button-sm"></p-dropdown>
            </div>
        </div>

    <!-- Tabla Principal -->
    <p-table
      [value]="plantillaAsistenciaList"
      dataKey="pla20plantillacod"
      editMode="row"
      [paginator]="true"
      [rows]="rowsPerPage"
      responsiveLayout="scroll"
      styleClass="p-datatable-sm"
      >
        <!-- Cabecera de Tabla -->
        <ng-template pTemplate="header">
            <tr>
                <th style="text-align: center;">Descripción</th>
                <th style="text-align: center;">Mod.Usuario</th>
                <th style="text-align: center;">Reg.Inasistencia</th>
                <th style="text-align: center;">Acciones</th>
            </tr>
        </ng-template>

        <!-- Cuerpo de Tabla -->
        <ng-template pTemplate="body" let-plantilla let-editing="editing" let-ri="rowIndex">
            <tr [pEditableRow]="plantilla">

              <td>
                  <p-cellEditor>
                    <ng-template pTemplate="input">
                      <input type="text" pInputText [(ngModel)]="plantilla.pla20descripcion" class="p-inputtext-sm w-full" required />
                    </ng-template>
                    <ng-template pTemplate="output">
                      {{ plantilla.pla20descripcion }}
                    </ng-template>
                  </p-cellEditor>
                </td>

                <td style="text-align: center;">
                  <!-- Mod.Usuario como checkbox (S = checked, N = unchecked) -->
                  <p-checkbox
                    [binary]="true"
                    [ngModel]="plantilla.pla20flagmodifxusuario === 'S'"
                    (onChange)="onToggleFlag(plantilla, 'pla20flagmodifxusuario', $event.checked)"
                    [disabled]="!editing">
                  </p-checkbox>

                  <!--
                  <p-cellEditor>
                    <ng-template pTemplate="input">
                      <input  type="text" pInputText [(ngModel)]="plantilla.pla20flagmodifxusuario" class="p-inputtext-sm w-full" required />
                    </ng-template>
                    <ng-template pTemplate="output">
                      {{ plantilla.pla20flagmodifxusuario }}
                    </ng-template>
                  </p-cellEditor>
                -->
                </td>

                <td style="text-align: center;">
                  <!-- Reg.Inasistencia como checkbox (S = checked, N = unchecked) -->
                  <p-checkbox
                    [binary]="true"
                    [ngModel]="plantilla.pla20flagregistrainasis === 'S'"
                    (onChange)="onToggleFlag(plantilla, 'pla20flagregistrainasis', $event.checked)"
                    [disabled]="!editing">
                  </p-checkbox>

                  <!--
                  <p-cellEditor>
                    <ng-template pTemplate="input">
                      <input type="text" pInputText [(ngModel)]="plantilla.pla20flagregistrainasis" class="p-inputtext-sm w-full" required />
                    </ng-template>
                    <ng-template pTemplate="output">
                      {{ plantilla.pla20flagregistrainasis }}
                    </ng-template>
                  </p-cellEditor>
                -->
                </td>

                <td>
                    <div class="flex justify-content-center gap-2">
                            <!-- Ver Detalle
                             Falta agregar onClick-->

                            <button
                                    pButton
                                    type="button"
                                    icon="pi pi-eye"
                                    pTooltip="Ver Detalle"
                                    class="p-button-rounded p-button-text p-button-sm"
                                    (click)="showDetalle(plantilla)"
                                    [disabled]="isNew || isEditingAnyRow"
                                    ></button>

                            <!-- Botón Editar -->
                            <button
                                    *ngIf="!editing" pButton
                                    pInitEditableRow
                                    (click)="onRowEditInit(plantilla)"
                                    icon="pi pi-pencil"
                                    pTooltip="Editar"
                                    [disabled]="isNew || isEditingAnyRow"
                                    class="p-button-rounded p-button-text p-button-sm"

                                    ></button>

                            <!-- Botón Guardar -->
                            <button
                                    *ngIf="editing"
                                    pButton
                                    pSaveEditableRow
                                    (click)="onRowEditSave(plantilla)"
                                    icon="pi pi-check"
                                    pTooltip="Guardar"
                                    class="p-button-rounded p-button-text p-button-sm p-button-success"
                                    ></button>

                            <!-- Botón Cancelar -->
                            <button
                                    *ngIf="editing"
                                    pButton
                                    pCancelEditableRow
                                    (click)="onRowEditCancel(plantilla, ri)"
                                    icon="pi pi-times"
                                    pTooltip="Cancelar"
                                    class="p-button-rounded p-button-text p-button-sm p-button-danger"
                                    ></button>

                            <!-- Botón Eliminar -->
                            <button
                                    *ngIf="!editing"
                                    pButton
                                    type="button"
                                    (click)="onDelete(plantilla)"
                                    icon="pi pi-trash"
                                    pTooltip="Eliminar"
                                    [disabled]="isNew || isEditingAnyRow"
                                    class="p-button-rounded p-button-text p-button-sm p-button-danger"
                                    ></button>
                      </div>
                </td>
            </tr>
        </ng-template>

        <!-- Footer para Nueva Plantilla-->
        <ng-template pTemplate="footer">
          <tr *ngIf="isEditing">
              <td colspan="4">
                  <form [formGroup]="plantillaAsistenciaForm" class="grid p-fluid">
                      <!-- Código Plantilla -->
                      <div class="col-3" style="width: 25%">
                          <input pInputText
                              formControlName="pla20plantillacod"
                              placeholder="Código (necesario por el momento)"
                              class="p-inputtext-sm w-full"/>
                      </div>

                      <!-- Descripción -->
                      <div class="col-3" style="width: 25%">
                          <input pInputText
                              formControlName="pla20descripcion"
                              placeholder="Descripción"
                              class="p-inputtext-sm w-full"/>
                      </div>

                      <!-- Mod.Usuario (formulario) -->
                      <div class="col-2" style="width: 25%">
                          <p-checkbox [binary]="true" formControlName="pla20flagmodifxusuario"></p-checkbox>
                      </div>
                      <!--
                      <div class="col-2" style="width: 25%">
                          <input pInputText
                              formControlName="pla20flagmodifxusuario"
                              placeholder="Mod.Usuario"
                              class="p-inputtext-sm w-full"/>
                      </div>
                      -->

                      <!-- Reg.Inasistencia (formulario) -->
                      <div class="col-2" style="width: 25%">
                          <p-checkbox [binary]="true" formControlName="pla20flagregistrainasis"></p-checkbox>
                      </div>
                      <!--
                      <div class="col-2" style="width: 25%">
                          <input pInputText
                              formControlName="pla20flagregistrainasis"
                              placeholder="Reg.Inasistencia"
                              class="p-inputtext-sm w-full"/>
                      </div>
                      -->

                      <!-- Botones de Acción -->
                      <div class="col-2" style="width: 100%">
                          <div class="flex gap-2 justify-content-center">
                              <button pButton type="button" icon="pi pi-check" class="p-button-success p-button-sm"
                                      (click)="onSave()" pTooltip="Guardar"></button>
                              <button pButton type="button" icon="pi pi-times" class="p-button-danger p-button-sm"
                                      (click)="onCancel()" pTooltip="Cancelar"></button>
                          </div>
                      </div>
                  </form>
              </td>
          </tr>
      </ng-template>
    </p-table>
  </div>
</div>
