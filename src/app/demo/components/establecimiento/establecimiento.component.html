<div class="p-4 bg-gray-50 min-h-screen">
    <p-toast></p-toast>
    <!-- La clave 'confirmDelete' debe coincidir con la clave usada en el componente TS -->
    <p-confirmDialog [style]="{width: '50vw'}" key="confirmDelete"></p-confirmDialog>

    <p-card header="Gestión de Establecimientos" [styleClass]="'shadow-xl rounded-xl'">

        <!-- CORRECCIÓN: Este div que contiene el toolbar NO tiene *ngIf para asegurar que siempre sea visible -->
        <div class="mb-4">
            <p-toolbar styleClass="bg-white rounded-lg border-0 shadow-md">
                <div class="p-toolbar-group-start">
                    <p-button 
                        label="Agregar" 
                        icon="pi pi-plus" 
                        styleClass="p-button-sm p-button-info mr-2" 
                        (onClick)="agregarEstablecimiento()"
                        [disabled]="!!editingEstablecimiento" 
                        pTooltip="Agrega un nuevo registro en línea">
                    </p-button>
                </div>
                
                <div class="p-toolbar-group-end">
                    <div class="flex align-items-center">
                        <label for="rowsPerPageTable" class="mr-2 text-sm text-gray-700">Filas por página:</label>
                        <!-- Usamos [(ngModel)] para enlazar con rowsPerPage -->
                        <p-dropdown id="rowsPerPageTable" 
                                    [options]="[10, 20, 40]" 
                                    [(ngModel)]="rowsPerPage" 
                                    placeholder="10" 
                                    styleClass="p-button-sm w-16 text-center">
                        </p-dropdown>
                    </div>
                </div>
            </p-toolbar>
        </div>
        
        <!-- Contenedor de la Tabla -->
        <div>
            <p-table 
                [value]="establecimientos" 
                [rows]="rowsPerPage" 
                [paginator]="true" 
                responsiveLayout="scroll"
                styleClass="p-datatable-sm"
            >
                <!-- Encabezado de la Tabla -->
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 10%; text-align: center;">Código</th>
                        <th style="width: 30%; text-align: center;">Denominación</th>
                        <th style="width: 20%; text-align: center;">EstablecimientoTipoDes</th>
                        <th style="width: 10%; text-align: center;">SCRT</th>
                        <th style="width: 15%; text-align: center;">SCTR - Tasa</th>
                        <th style="width: 15%; text-align: center;">Acciones</th>
                    </tr>
                </ng-template>

                <!-- Cuerpo de la Tabla (Edición en línea) -->
                <ng-template pTemplate="body" let-establecimiento>
                    <tr>
                        <!-- Columna Código -->
                        <td class="text-center">
                            <!-- Toggle entre Edición (input) y Vista (texto) -->
                            <div *ngIf="editingEstablecimiento?.pla20codigo === establecimiento.pla20codigo; else displayCodigo">
                                <input pInputText type="text" 
                                    [(ngModel)]="editingEstablecimiento!.pla20codigo" 
                                    placeholder="Código"
                                    class="w-full text-sm text-center font-bold"
                                    [disabled]="!isAddMode" /> 
                            </div>
                            <ng-template #displayCodigo>
                                {{ establecimiento.pla20codigo }}
                            </ng-template>
                        </td>

                        <!-- Columna Denominación -->
                        <td class="text-center">
                            <div *ngIf="editingEstablecimiento?.pla20codigo === establecimiento.pla20codigo; else displayDenominacion">
                                <input pInputText type="text" 
                                    [(ngModel)]="editingEstablecimiento!.pla20denominacion" 
                                    class="w-full text-sm text-center" />
                            </div>
                            <ng-template #displayDenominacion>
                                {{ establecimiento.pla20denominacion }}
                            </ng-template>
                        </td>

                        <!-- Columna Tipo de Establecimiento -->
                        <td class="text-center">
                            <div *ngIf="editingEstablecimiento?.pla20codigo === establecimiento.pla20codigo; else displayTipo">
                                <p-dropdown 
                                    [options]="tipoOptions" 
                                    optionLabel="label" 
                                    optionValue="value"
                                    [(ngModel)]="editingEstablecimiento!.pla20establecimientotipo"
                                    placeholder="Seleccionar Tipo"
                                    styleClass="w-full text-sm text-left">
                                </p-dropdown>
                            </div>
                            <ng-template #displayTipo>
                                <span class="font-medium text-gray-700">{{ getEstablecimientoTipoLabel(establecimiento.pla20establecimientotipo) }}</span>
                            </ng-template>
                        </td>

                        <!-- Columna SCTR Flag (Checkbox) -->
                        <td class="text-center">
                            <div *ngIf="editingEstablecimiento?.pla20codigo === establecimiento.pla20codigo; else displaySctrFlag">
                                <p-checkbox [binary]="true" [(ngModel)]="editingEstablecimiento!.pla20sctrflag"></p-checkbox>
                            </div>
                            <ng-template #displaySctrFlag>
                                <i *ngIf="establecimiento.pla20sctrflag" class="pi pi-check text-green-600"></i>
                                <i *ngIf="!establecimiento.pla20sctrflag" class="pi pi-times text-red-500"></i>
                            </ng-template>
                        </td>

                        <!-- Columna SCTR Tasa (Input Number) -->
                        <td class="text-center">
                            <div *ngIf="editingEstablecimiento?.pla20codigo === establecimiento.pla20codigo; else displaySctrTasa">
                                <input pInputText type="number" 
                                    [(ngModel)]="editingEstablecimiento!.pla20sctrtasa"                             
                                    [disabled]="!editingEstablecimiento!.pla20sctrflag" 
                                    placeholder="0.00"
                                    class="w-full text-sm text-center" />
                            </div>
                            <ng-template #displaySctrTasa>
                                <span *ngIf="establecimiento.pla20sctrflag && establecimiento.pla20sctrtasa !== null">{{ establecimiento.pla20sctrtasa | number:'1.2-2' }}</span>
                                
                            </ng-template>
                        </td>

                        <!-- Columna Acciones -->
                        <td>
                            <div class="flex justify-content-center gap-2">
                                <!-- Botones de Edición (Guardar/Cancelar) -->
                                <div *ngIf="editingEstablecimiento?.pla20codigo === establecimiento.pla20codigo">
                                    <p-button 
                                        icon="pi pi-check" 
                                        styleClass="p-button-sm p-button-primary p-button-text" 
                                        pTooltip="Guardar"
                                        (onClick)="onRowGuardarEdicion(establecimiento)">
                                    </p-button>
                                    <p-button 
                                        icon="pi pi-times" 
                                        styleClass="p-button-sm p-button-danger p-button-text" 
                                        pTooltip="Cancelar"
                                        (onClick)="onRowCancelarEdicion(establecimiento)">
                                    </p-button>
                                </div>
                                
                                <!-- Botones de vista (Editar/Eliminar) -->
                                <div *ngIf="editingEstablecimiento?.pla20codigo !== establecimiento.pla20codigo">
                                    <p-button 
                                        icon="pi pi-pencil" 
                                        styleClass="p-button-sm p-button-info p-button-text" 
                                        pTooltip="Editar"
                                        (onClick)="onRowEditarEstablecimiento(establecimiento)"                                    
                                        [disabled]="!!editingEstablecimiento">
                                    </p-button>
                                    <p-button 
                                        icon="pi pi-trash" 
                                        styleClass="p-button-sm p-button-danger p-button-text" 
                                        pTooltip="Eliminar"
                                        (onClick)="eliminarEstablecimiento(establecimiento)"
                                        [disabled]="!!editingEstablecimiento">
                                    </p-button>
                                </div>
                            </div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="6" class="text-center text-gray-500 py-4">
                            <i class="pi pi-info-circle mr-2"></i> No se encontraron establecimientos.
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </p-card>
</div>
