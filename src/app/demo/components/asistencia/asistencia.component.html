<div class="asistencia-container">
  <!-- Toast para notificaciones -->
  <p-toast></p-toast>
  
  <!-- Confirm Dialog -->
  <p-confirmDialog></p-confirmDialog>

  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <i class="pi pi-users header-icon"></i>
      <h2>Asistencia de Personal</h2>
    </div>
  </div>

  <!-- Card contenedor -->
  <div class="content-card">
    <!-- Toolbar con acciones -->
    <p-toolbar styleClass="custom-toolbar">
      <ng-template pTemplate="left">
        <div class="toolbar-group">
          <button pButton type="button" 
                  icon="pi pi-save" 
                  class="p-button-success toolbar-button"
                  (click)="guardar()"
                  pTooltip="Guardar cambios"
                  tooltipPosition="bottom"></button>
          
          <button pButton type="button" 
                  icon="pi pi-times" 
                  class="p-button-danger toolbar-button"
                  (click)="cancelar()"
                  pTooltip="Cancelar"
                  tooltipPosition="bottom"></button>
          
          <button pButton type="button" 
                  icon="pi pi-eye" 
                  class="p-button-info toolbar-button"
                  (click)="vistaPrevia()"
                  pTooltip="Vista previa"
                  tooltipPosition="bottom"></button>
          
          <button pButton type="button" 
                  icon="pi pi-print" 
                  class="p-button-secondary toolbar-button"
                  (click)="imprimir()"
                  pTooltip="Imprimir"
                  tooltipPosition="bottom"></button>
        </div>
      </ng-template>

      <ng-template pTemplate="right">
        <div class="toolbar-group">
          <button pButton type="button" 
                  icon="pi pi-calendar-times" 
                  class="p-button-warning toolbar-button-text"
                  (click)="registrarInasistencia()"
                  [disabled]="!selectedTrabajador"
                  pTooltip="Registrar inasistencia del trabajador seleccionado"
                  tooltipPosition="bottom"></button>
          
          <button pButton type="button" 
                  icon="pi pi-trash" 
                  class="p-button-danger toolbar-button"
                  (click)="eliminar()"
                  [disabled]="!selectedTrabajador"
                  pTooltip="Eliminar"
                  tooltipPosition="bottom"></button>
          
          <button pButton type="button" 
                  icon="pi pi-refresh" 
                  class="p-button-help toolbar-button"
                  (click)="refrescar()"
                  pTooltip="Refrescar datos"
                  tooltipPosition="bottom"></button>
        </div>
      </ng-template>
    </p-toolbar>

    <div class="table-controls-header flex justify-content-end align-items-center" style="padding: 0.8rem 1rem; border-top: 1px solid #dee2e6;">
            <div class="flex align-items-center px-2">
                <label for="rowsPerPageTable" style="margin-right: 0.5rem; font-weight: 600; font-size: 0.9rem;">Filas por página:</label>
                <p-dropdown id="rowsPerPageTable" [options]="[10, 20, 40, 50]" [(ngModel)]="rowsPerPage" appendTo="body"
                    placeholder="Seleccionar" styleClass="p-button-sm w-12 text-center"></p-dropdown>
            </div>          
        </div>

    <!-- Tabla de asistencia -->
    <div class="table-container">
      <p-table 
        #dt [value]="trabajadores" [(selection)]="selectedTrabajador" selectionMode="single" [paginator]="true" 
                [rows]="rowsPerPage"
                responsiveLayout="scroll"
                [showCurrentPageReport]="false"
                [globalFilterFields]="['codigo', 'idIdentidad', 'apellidosNombres', 'estado']"
                [tableStyle]="{ 'min-width': '100%' }" styleClass="p-datatable-striped p-datatable-gridlines">
        
        <!-- Caption con filtro -->
        <!--<ng-template pTemplate="caption">
          <div class="table-header">
            <span class="p-input-icon-left search-input">
              <i class="pi pi-search"></i>
              <input pInputText type="text" 
                     [(ngModel)]="globalFilterValue"
                     (input)="onGlobalFilter($event)"
                     placeholder="Buscar trabajador..." />
            </span>
          </div>
        </ng-template>-->

        <!-- Columnas -->
        <ng-template pTemplate="header">
          <tr>
            <th style="min-width: 90px;">
              Código <!--<p-sortIcon field="codigo"></p-sortIcon>-->
            </th>
            <th style="min-width: 110px;">
              IdentidadNro
            </th>
            <th style="min-width: 250px;">
              Apellidos y Nombres 
            </th>
            <th style="min-width: 120px;">
              Fecha Ingreso
            </th>
            <th style="min-width: 90px;">
              Estado 
            </th>
            <th style="min-width: 90px;">
              Acciones
            </th>
          </tr>
        </ng-template>

        <!-- Filas -->
        <ng-template pTemplate="body" let-trabajador>
          <tr [pSelectableRow]="trabajador" 
              [class.selected-row]="selectedTrabajador === trabajador">
            <td>{{ trabajador.codigo }}</td>
            <td>{{ trabajador.idIdentidad }}</td>
            <td>{{ trabajador.apellidosNombres }}</td>
            <td>{{ trabajador.fechaIngreso | date:'dd/MM/yyyy' }}</td>
            <td>
              <span [ngClass]="{'status-closed': trabajador.estado === 'CERRADO', 'status-active': trabajador.estado === 'ACTIVO'}">
                                {{ getEstadoLabel(trabajador.estado) }}
                            </span>
            </td>
            <td class="text-center"></td>
          </tr>
        </ng-template>

        <!-- Empty message -->
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="17" class="text-center empty-message">
              <i class="pi pi-info-circle"></i>
              <p>No se encontraron trabajadores</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Dialog para registrar inasistencia -->
  <p-dialog 
    [(visible)]="displayInasistenciaDialog" 
    header="Inasistencia de Personal"
    [modal]="true"
    [style]="{width: '700px'}"
    [draggable]="false"
    [resizable]="false"
    styleClass="custom-dialog">
    
    <div class="dialog-content">
      <div class="worker-info" *ngIf="selectedTrabajador">
        <div class="info-row">
          <span class="info-label">Trabajador:</span>
          <span class="info-value">{{ selectedTrabajador.apellidosNombres }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Código:</span>
          <span class="info-value">{{ selectedTrabajador.codigo }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">DNI:</span>
          <span class="info-value">{{ selectedTrabajador.idIdentidad }}</span>
        </div>
      </div>

      <div class="form-grid">
        <!-- Tipo Suspensión -->
        <div class="form-field full-width">
          <label for="tipoSuspension" class="form-label">
            Tipo de Suspensión: <span class="required">*</span>
          </label>
          <p-dropdown id="tipoSuspension" 
                      [(ngModel)]="inasistenciaForm.tipoSuspension"
                      [options]="tipoSuspensionOptions"
                      optionLabel="label"
                      optionValue="value"
                      placeholder="Seleccione tipo de suspensión"
                      styleClass="w-full"></p-dropdown>
        </div>

        <!-- Descripción -->
        <div class="form-field full-width">
          <label for="descripcion" class="form-label">
            Descripción:
          </label>
          <input id="descripcion" type="text" pInputText 
                 [(ngModel)]="inasistenciaForm.descripcion" 
                 class="w-full"
                 placeholder="Ingrese una descripción o motivo"/>
        </div>

        <!-- Fecha Inicio -->
        <div class="form-field">
          <label for="fecIni" class="form-label">
            Fecha Inicio: <span class="required">*</span>
          </label>
          <p-calendar id="fecIni" 
                      [(ngModel)]="inasistenciaForm.fechaInicio" 
                      dateFormat="dd/mm/yy"
                      [showIcon]="true"
                      (onSelect)="calcularDias()"
                      inputStyleClass="w-full"
                      styleClass="w-full"></p-calendar>
        </div>

        <!-- Fecha Fin -->
        <div class="form-field">
          <label for="fecFin" class="form-label">
            Fecha Fin: <span class="required">*</span>
          </label>
          <p-calendar id="fecFin" 
                      [(ngModel)]="inasistenciaForm.fechaFin" 
                      dateFormat="dd/mm/yy"
                      [showIcon]="true"
                      (onSelect)="calcularDias()"
                      inputStyleClass="w-full"
                      styleClass="w-full"></p-calendar>
        </div>

        <!-- Días No Trabajados -->
        <div class="form-field">
          <label for="diasNoTrab" class="form-label">
            Días No Trabajados:
          </label>
          <p-inputNumber id="diasNoTrab" 
                         [(ngModel)]="inasistenciaForm.diasNoTrabajados"
                         [min]="0"
                         [readonly]="true"
                         styleClass="w-full"></p-inputNumber>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button pButton type="button" 
              label="Cancelar" 
              icon="pi pi-times"
              class="p-button-secondary p-button-outlined"
              (click)="displayInasistenciaDialog = false"></button>
      <button pButton type="button" 
              label="Guardar" 
              icon="pi pi-check"
              (click)="guardarInasistencia()"></button>
    </ng-template>
  </p-dialog>
</div>