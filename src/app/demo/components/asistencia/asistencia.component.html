<div class="p-1 sm:p-6 lg:p-8 min-h-screen">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <div *ngIf="isMenuOpen" class="max-w-7xl mx-auto">

        <p-card header="Asistencia de Personal" styleClass="shadow-xl rounded-lg">


            <p-toolbar styleClass="mb-4 p-3 rounded-lg bg-white shadow-sm border-1 border-gray-200">
                <div class="p-toolbar-group-start flex flex-wrap gap-3">
                    <button pButton pRipple icon="pi pi-trash" class="p-button-danger p-button-sm"
                        (click)="eliminarEmpleado()" pTooltip="Eliminar empleado"></button>

                    <button pButton pRipple icon="pi pi-save" class="p-button-success p-button-sm" (click)="guardar()"
                        pTooltip="Guardar"></button>

                    <button pButton pRipple icon="pi pi-times" class="p-button-secondary p-button-sm"
                        (click)="cancelar()" pTooltip="Cancelar y cerrar la vista"></button>

                    <button pButton pRipple icon="pi pi-eye" class="p-button-info p-button-sm" (click)="vistaPrevia()"
                        pTooltip="Vista previa"></button>
                </div>

                <div class="p-toolbar-group-end flex flex-wrap items-center space-x-2">
                    <span class="text-sm font-semibold whitespace-nowrap px-2">Período Pago:</span>

                    <p-dropdown [options]="periodoPagoOptions" [(ngModel)]="selectedPeriodoPago" optionLabel="label"
                        optionValue="value" placeholder="Seleccionar Período" styleClass="w-64"
                        (onChange)="loadEmpleados()" class="mr-2 dropdown-periodo-fijo">
                    </p-dropdown>

                </div>

            </p-toolbar>

            <div class="table-controls-header flex justify-content-end align-items-center"
                style="padding: 0.8rem 1rem;">
                <div class="flex align-items-center">
                    <label for="rowsPerPageTable"
                        style="margin-right: 0.5rem; font-weight: 600; font-size: 0.9rem;">Filas por página:</label>
                    <p-dropdown id="rowsPerPageTable" [options]="[10, 20, 40, 50]" [(ngModel)]="rowsPerPage"
                        appendTo="body" placeholder="Seleccionar"
                        styleClass="p-button-sm w-12 text-center"></p-dropdown>
                </div>
            </div>


            <p-table #dt 
                [value]="empleados" [paginator]="true" [rows]="rowsPerPage" [first]="first"
                [totalRecords]="totalRecords" (onPage)="onPageChange($event)" responsiveLayout="stack"
                dataKey="pla01empleadocod" selectionMode="single" 
                [(selection)]="selectedEmpleado" styleClass="p-datatable-gridlines p-datatable-sm shadow-md rounded-lg overflow-hidden">

                <ng-template pTemplate="header">
                    <tr>
                        <th class="w-1 text-center">Código</th>
                        <th class="w-1 text-center">DNI / Identidad</th>
                        <th class="w-4 text-center">Apellidos y Nombres</th>
                        <th class="w-1 text-center">F. Ingreso</th>
                        <th class="w-1 text-center">Estado</th>
                        <th class="w-1 text-center">
                            {{ getDynamicColumnLabel() }}
                        </th>
                        <th class="w-1 text-center">Inasistencias</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-empleado> <tr [pSelectableRow]="empleado">
                        <td class="text-center">{{ empleado.pla01empleadocod }}</td>
                        <td class="text-center">{{ empleado.idIdentidad }}</td>
                        <td class="text-center">{{ empleado.apellidosynombres }}</td>
                        <td class="text-center">{{ empleado.pla01fechaingreso | date: 'dd/MM/yyyy' }}</td>
                        <td class="text-center">
                            {{ getEstadoLabel(empleado.pla01estado) }}
                        </td>

                        <td class="w-24 text-center p-0">
                            <div class="flex justify-center w-full">
                                <input pInputText type="number" [min]="0" step="any" [max]="360"
                                    class="w-16 border border-gray-300 rounded input-dias-asistencia"
                                    *ngIf="selectedPeriodoPago === 'UTILIDADES'" [(ngModel)]="empleado.pla02utilidad"
                                    (ngModelChange)="empleado.pla02utilidad = $event > 360 ? 360 : $event < 0 ? 0 : $event" />

                                <input pInputText type="number" [min]="0" step="any" [max]="180"
                                    class="w-16 border border-gray-300 rounded input-dias-asistencia"
                                    *ngIf="selectedPeriodoPago === 'GRATIFICACIONES'"
                                    [(ngModel)]="empleado.pla02gratificacion"
                                    (ngModelChange)="empleado.pla02gratificacion = $event > 180 ? 180 : $event < 0 ? 0 : $event" />
                            </div>
                        </td>

                        <td class="text-center">
                            <button pButton pRipple icon="pi pi-user"
                                class="p-button-rounded p-button-info p-button-text p-button-sm"
                                pTooltip="Ver/Registrar Inasistencias" (click)="openInasistenciaDialog(empleado)">
                            </button>
                        </td>
                    </tr>
                </ng-template>

            </p-table>
        </p-card>
    </div>

    <div *ngIf="!isMenuOpen" class="flex items-center justify-center h-screen -mt-20">
        <p-card header="Vista Cerrada" styleClass="shadow-lg bg-white">
            <p class="text-lg text-gray-700">La vista ha sido cerrada. Para volver a cargarla, presione el botón.</p>
            <button pButton label="Abrir Menú de Asistencia" icon="pi pi-folder-open" class="mt-4"
                (click)="isMenuOpen = true"></button>
        </p-card>
    </div>
</div>

<p-dialog header="Inasistencia de Personal" [(visible)]="displayInasistenciaDialog" [modal]="true" [maximizable]="true"
    [style]="{ width: '70vw', minWidth: '300px' }" [draggable]="true" [resizable]="true">
    <div *ngIf="selectedInasistenciaEmpleado"> <h3 class="text-lg font-semibold mb-3">Empleado: {{ selectedInasistenciaEmpleado.apellidosynombres }} ({{
            selectedInasistenciaEmpleado.pla01empleadocod }})</h3>

        <p-panel header="Detalle de Inasistencias del Personal" [style]="{'margin-top':'10px'}">
            <p>Aquí irá la tabla o formulario para registrar/editar las inasistencias (Faltas, Licencias, etc.).</p>
        </p-panel>
    </div>

    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cerrar" icon="pi pi-times" (click)="displayInasistenciaDialog=false"
            class="p-button-secondary"></button>
    </ng-template>
</p-dialog>