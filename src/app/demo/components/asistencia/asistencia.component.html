<div class="asistencia-container">
  <!-- Toast para notificaciones -->
  <p-toast></p-toast>
  
  <!-- Confirm Dialog -->
  <p-confirmDialog></p-confirmDialog>

  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <i class="pi pi-users header-icon"></i>
      <h2>Asistencia de Personal</h2>
    </div>
  </div>

  <!-- Card contenedor -->
  <div class="content-card">
    <!-- Toolbar con acciones -->
    <p-toolbar styleClass="custom-toolbar">
      <ng-template pTemplate="left">
        <div class="toolbar-group">
          <button pButton type="button" 
                  icon="pi pi-save" 
                  class="p-button-success toolbar-button"
                  (click)="guardar()"
                  pTooltip="Guardar cambios"
                  tooltipPosition="bottom"></button>
          
          <button pButton type="button" 
                  icon="pi pi-times" 
                  class="p-button-danger toolbar-button"
                  (click)="cancelar()"
                  pTooltip="Cancelar"
                  tooltipPosition="bottom"></button>
          
          <button pButton type="button" 
                  icon="pi pi-eye" 
                  class="p-button-info toolbar-button"
                  (click)="vistaPrevia()"
                  pTooltip="Vista previa"
                  tooltipPosition="bottom"></button>
          
          <button pButton type="button" 
                  icon="pi pi-print" 
                  class="p-button-secondary toolbar-button"
                  (click)="imprimir()"
                  pTooltip="Imprimir"
                  tooltipPosition="bottom"></button>
        </div>
      </ng-template>

      <ng-template pTemplate="right">
        <div class="toolbar-group">
          <button pButton type="button" 
                  icon="pi pi-calendar-times" 
                  label="Registrar Inasistencia"
                  class="p-button-warning toolbar-button-text"
                  (click)="registrarInasistencia()"
                  [disabled]="!selectedTrabajador"
                  pTooltip="Registrar inasistencia del trabajador seleccionado"
                  tooltipPosition="bottom"></button>
          
          <button pButton type="button" 
                  icon="pi pi-trash" 
                  class="p-button-danger toolbar-button"
                  (click)="eliminar()"
                  [disabled]="!selectedTrabajador"
                  pTooltip="Eliminar"
                  tooltipPosition="bottom"></button>
          
          <button pButton type="button" 
                  icon="pi pi-refresh" 
                  class="p-button-help toolbar-button"
                  (click)="refrescar()"
                  pTooltip="Refrescar datos"
                  tooltipPosition="bottom"></button>
        </div>
      </ng-template>
    </p-toolbar>

    <!-- Tabla de asistencia -->
    <div class="table-container">
      <p-table 
        [value]="trabajadores" 
        [(selection)]="selectedTrabajador"
        selectionMode="single"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[5, 10, 20, 50]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} trabajadores"
        [globalFilterFields]="['codigo', 'idIdentidad', 'apellidosNombres', 'estado']"
        [scrollable]="true"
        scrollHeight="flex"
        [tableStyle]="{ 'min-width': '100%' }"
        styleClass="p-datatable-striped p-datatable-gridlines p-datatable-sm">
        
        <!-- Caption con filtro -->
        <ng-template pTemplate="caption">
          <div class="table-header">
            <span class="p-input-icon-left search-input">
              <i class="pi pi-search"></i>
              <input pInputText type="text" 
                     [(ngModel)]="globalFilterValue"
                     (input)="onGlobalFilter($event)"
                     placeholder="Buscar trabajador..." />
            </span>
          </div>
        </ng-template>

        <!-- Columnas -->
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="codigo" style="min-width: 90px;">
              Código <p-sortIcon field="codigo"></p-sortIcon>
            </th>
            <th pSortableColumn="idIdentidad" style="min-width: 110px;">
              ID/DNI <p-sortIcon field="idIdentidad"></p-sortIcon>
            </th>
            <th pSortableColumn="apellidosNombres" style="min-width: 250px;">
              Apellidos y Nombres <p-sortIcon field="apellidosNombres"></p-sortIcon>
            </th>
            <th pSortableColumn="fechaIngreso" style="min-width: 120px;">
              Fecha Ingreso <p-sortIcon field="fechaIngreso"></p-sortIcon>
            </th>
            <th pSortableColumn="estado" style="min-width: 90px;">
              Estado <p-sortIcon field="estado"></p-sortIcon>
            </th>
            <th pSortableColumn="dias" style="min-width: 70px;">
              Días <p-sortIcon field="dias"></p-sortIcon>
            </th>
            <th style="min-width: 70px;">Horas</th>
            <th style="min-width: 90px;">HE Simples</th>
            <th style="min-width: 90px;">HE Dobles</th>
            <th style="min-width: 80px;">HE 100</th>
            <th style="min-width: 90px;">H Nocturnas</th>
            <th style="min-width: 80px;">Días Comp.</th>
            <th style="min-width: 110px;">Días Enfermedad</th>
            <th style="min-width: 150px;">Días Subsidio Enfermedad</th>
            <th style="min-width: 150px;">Días Subsidio Materno</th>
            <th style="min-width: 110px;">Días Licencia</th>
            <th pSortableColumn="faltas" style="min-width: 80px;">
              Faltas <p-sortIcon field="faltas"></p-sortIcon>
            </th>
          </tr>
        </ng-template>

        <!-- Filas -->
        <ng-template pTemplate="body" let-trabajador>
          <tr [pSelectableRow]="trabajador" 
              [class.selected-row]="selectedTrabajador === trabajador">
            <td>{{ trabajador.codigo }}</td>
            <td>{{ trabajador.idIdentidad }}</td>
            <td>{{ trabajador.apellidosNombres }}</td>
            <td>{{ trabajador.fechaIngreso | date:'dd/MM/yyyy' }}</td>
            <td>
              <p-tag [value]="getEstadoLabel(trabajador.estado)" 
                     [severity]="getSeverity(trabajador.estado)"></p-tag>
            </td>
            <td class="text-center">{{ trabajador.dias }}</td>
            <td class="text-center">{{ trabajador.horas }}</td>
            <td class="text-center">{{ trabajador.heSimples }}</td>
            <td class="text-center">{{ trabajador.heDobles }}</td>
            <td class="text-center">{{ trabajador.he100 }}</td>
            <td class="text-center">{{ trabajador.hNocturnas }}</td>
            <td class="text-center">{{ trabajador.diasCompensados }}</td>
            <td class="text-center">{{ trabajador.diasEnfermedad }}</td>
            <td class="text-center">{{ trabajador.diasSubsidioEnfermedad }}</td>
            <td class="text-center">{{ trabajador.diasSubsidioMaterno }}</td>
            <td class="text-center">{{ trabajador.diasLicencia }}</td>
            <td class="text-center" [class.text-danger]="trabajador.faltas > 0">
              <strong>{{ trabajador.faltas }}</strong>
            </td>
          </tr>
        </ng-template>

        <!-- Empty message -->
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="17" class="text-center empty-message">
              <i class="pi pi-info-circle"></i>
              <p>No se encontraron trabajadores</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Dialog para registrar inasistencia -->
  <p-dialog 
    [(visible)]="displayInasistenciaDialog" 
    header="Inasistencia de Personal"
    [modal]="true"
    [style]="{width: '700px'}"
    [draggable]="false"
    [resizable]="false"
    styleClass="custom-dialog">
    
    <div class="dialog-content">
      <div class="worker-info" *ngIf="selectedTrabajador">
        <div class="info-row">
          <span class="info-label">Trabajador:</span>
          <span class="info-value">{{ selectedTrabajador.apellidosNombres }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Código:</span>
          <span class="info-value">{{ selectedTrabajador.codigo }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">DNI:</span>
          <span class="info-value">{{ selectedTrabajador.idIdentidad }}</span>
        </div>
      </div>

      <div class="form-grid">
        <!-- Tipo Suspensión -->
        <div class="form-field full-width">
          <label for="tipoSuspension" class="form-label">
            Tipo de Suspensión: <span class="required">*</span>
          </label>
          <p-dropdown id="tipoSuspension" 
                      [(ngModel)]="inasistenciaForm.tipoSuspension"
                      [options]="tipoSuspensionOptions"
                      optionLabel="label"
                      optionValue="value"
                      placeholder="Seleccione tipo de suspensión"
                      styleClass="w-full"></p-dropdown>
        </div>

        <!-- Descripción -->
        <div class="form-field full-width">
          <label for="descripcion" class="form-label">
            Descripción:
          </label>
          <input id="descripcion" type="text" pInputText 
                 [(ngModel)]="inasistenciaForm.descripcion" 
                 class="w-full"
                 placeholder="Ingrese una descripción o motivo"/>
        </div>

        <!-- Fecha Inicio -->
        <div class="form-field">
          <label for="fecIni" class="form-label">
            Fecha Inicio: <span class="required">*</span>
          </label>
          <p-calendar id="fecIni" 
                      [(ngModel)]="inasistenciaForm.fechaInicio" 
                      dateFormat="dd/mm/yy"
                      [showIcon]="true"
                      (onSelect)="calcularDias()"
                      inputStyleClass="w-full"
                      styleClass="w-full"></p-calendar>
        </div>

        <!-- Fecha Fin -->
        <div class="form-field">
          <label for="fecFin" class="form-label">
            Fecha Fin: <span class="required">*</span>
          </label>
          <p-calendar id="fecFin" 
                      [(ngModel)]="inasistenciaForm.fechaFin" 
                      dateFormat="dd/mm/yy"
                      [showIcon]="true"
                      (onSelect)="calcularDias()"
                      inputStyleClass="w-full"
                      styleClass="w-full"></p-calendar>
        </div>

        <!-- Días No Trabajados -->
        <div class="form-field">
          <label for="diasNoTrab" class="form-label">
            Días No Trabajados:
          </label>
          <p-inputNumber id="diasNoTrab" 
                         [(ngModel)]="inasistenciaForm.diasNoTrabajados"
                         [min]="0"
                         [readonly]="true"
                         styleClass="w-full"></p-inputNumber>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button pButton type="button" 
              label="Cancelar" 
              icon="pi pi-times"
              class="p-button-secondary p-button-outlined"
              (click)="displayInasistenciaDialog = false"></button>
      <button pButton type="button" 
              label="Guardar" 
              icon="pi pi-check"
              (click)="guardarInasistencia()"></button>
    </ng-template>
  </p-dialog>
</div>