<div class="p-1 sm:p-6 lg:p-8 min-h-screen">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <div *ngIf="isMenuOpen" class="max-w-7xl mx-auto">

        <p-card header="Asistencia de Personal" styleClass="shadow-xl rounded-lg">
            <p-toolbar styleClass="mb-4 p-3 rounded-lg bg-white shadow-sm border-1 border-gray-200">
                <div class="p-toolbar-group-start flex flex-wrap gap-3">
                    <button pButton pRipple icon="pi pi-trash" class="p-button-danger p-button-sm"
                        (click)="eliminarEmpleado()" pTooltip="Eliminar empleado"></button>
                    <button pButton pRipple icon="pi pi-save" class="p-button-success p-button-sm" (click)="guardar()"
                        pTooltip="Guardar"></button>
                    <button pButton pRipple icon="pi pi-times" class="p-button-secondary p-button-sm"
                        (click)="cancelar()" pTooltip="Cancelar y cerrar la vista"></button>
                    <button pButton pRipple icon="pi pi-eye" class="p-button-info p-button-sm" (click)="vistaPrevia()"
                        pTooltip="Vista previa"></button>
                </div>

                <div class="p-toolbar-group-end flex flex-wrap items-center space-x-2">
                    <span class="text-sm font-semibold whitespace-nowrap px-2">Período Pago:</span>
                    <p-dropdown [options]="periodoPagoOptions" [(ngModel)]="selectedPeriodoPago" optionLabel="label"
                        optionValue="value" placeholder="Seleccionar Período" styleClass="w-64"
                        (onChange)="loadEmpleados()" class="mr-2 dropdown-periodo-fijo">
                    </p-dropdown>
                </div>
            </p-toolbar>

            <div class="table-controls-header flex justify-content-end align-items-center"
                style="padding: 0.8rem 1rem;">
                <div class="flex align-items-center">
                    <label for="rowsPerPageTable"
                        style="margin-right: 0.5rem; font-weight: 600; font-size: 0.9rem;">Filas por página:</label>
                    <p-dropdown id="rowsPerPageTable" [options]="[10, 20, 40, 50]" [(ngModel)]="rowsPerPage"
                        appendTo="body" placeholder="Seleccionar"
                        styleClass="p-button-sm w-12 text-center"></p-dropdown>
                </div>
            </div>

            <p-table #dt 
                [value]="empleados" [paginator]="true" [rows]="rowsPerPage" [first]="first"
                [totalRecords]="totalRecords" (onPage)="onPageChange($event)" responsiveLayout="stack"
                dataKey="pla01empleadocod" selectionMode="single" 
                [(selection)]="selectedEmpleado" styleClass="p-datatable-gridlines p-datatable-sm shadow-md rounded-lg overflow-hidden">
                
                <ng-template pTemplate="header">
                    <tr>
                        <th class="w-1 text-center">Código</th>
                        <th class="w-1 text-center">Nro. Identidad</th>
                        <th class="w-4 text-center">Apellidos y Nombres</th>
                        <th class="w-1 text-center">Fecha Ingreso</th>
                        <th class="w-1 text-center">Estado</th>
                        <th class="w-1 text-center">{{ getDynamicColumnLabel() }}</th>
                        <th class="w-1 text-center">Inasistencias</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-empleado>
                    <tr [pSelectableRow]="empleado">
                        <td class="text-center">{{ empleado.pla01empleadocod }}</td>
                        <td class="text-center">{{ empleado.idIdentidad }}</td>
                        <td class="text-center">{{ empleado.apellidosynombres }}</td>
                        <td class="text-center">{{ empleado.pla01fechaingreso | date: 'dd/MM/yyyy' }}</td>
                        <td class="text-center"><p-tag [value]="getEstadoLabel(empleado.pla01estado)" [severity]="getSeverity(empleado.pla01estado)"></p-tag></td>
                        
                        <td class="w-24 text-center p-0">
                            <div class="flex justify-center w-full">
                                <input pInputText type="number" [min]="0" step="any" [max]="360"
                                    class="w-16 border border-gray-300 rounded input-dias-asistencia"
                                    *ngIf="selectedPeriodoPago === 'UTILIDADES'" [(ngModel)]="empleado.pla02utilidad"
                                    (ngModelChange)="empleado.pla02utilidad = $event > 360 ? 360 : $event < 0 ? 0 : $event" />

                                <input pInputText type="number" [min]="0" step="any" [max]="180"
                                    class="w-16 border border-gray-300 rounded input-dias-asistencia"
                                    *ngIf="selectedPeriodoPago === 'GRATIFICACIONES'"
                                    [(ngModel)]="empleado.pla02gratificacion"
                                    (ngModelChange)="empleado.pla02gratificacion = $event > 180 ? 180 : $event < 0 ? 0 : $event" />
                            </div>
                        </td>

                        <td class="text-center">
                            <button pButton pRipple icon="pi pi-user"
                                class="p-button-rounded p-button-info p-button-text p-button-sm"
                                pTooltip="Ver/Registrar Inasistencias" (click)="openInasistenciaDialog(empleado)">
                            </button>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </p-card>
    </div>

    <div *ngIf="!isMenuOpen" class="flex items-center justify-center h-screen -mt-20">
        <p-card header="Vista Cerrada" styleClass="shadow-lg bg-white">
            <p class="text-lg text-gray-700">La vista ha sido cerrada. Para volver a cargarla, presione el botón.</p>
            <button pButton label="Abrir Menú de Asistencia" icon="pi pi-folder-open" class="mt-4"
                (click)="isMenuOpen = true"></button>
        </p-card>
    </div>
</div>

<p-dialog header="Inasistencia de Personal" [(visible)]="displayInasistenciaDialog" [modal]="true" [maximizable]="true"
    [style]="{ width: '80vw', minWidth: '400px' }" [draggable]="true" [resizable]="true">
    <div *ngIf="selectedInasistenciaEmpleado">
        <h3 class="text-lg font-semibold mb-3">Empleado: {{ selectedInasistenciaEmpleado.apellidosynombres }} ({{ selectedInasistenciaEmpleado.pla01empleadocod }})</h3>

        <p-toolbar styleClass="mb-3 p-2 border-1 border-gray-200 rounded-md">
            <div class="p-toolbar-group-start">
                <button pButton pRipple icon="pi pi-plus" label="Añadir Inasistencia" (click)="addInasistencia()" [disabled]="isEditingInasistencia"
                    class="p-button-info p-button-sm"></button>
            </div>
        </p-toolbar>

        <p-table [value]="inasistencias" [rowHover]="true" dataKey="pla03tiposuspension" 
                 [(selection)]="selectedInasistencia" selectionMode="single"
                 styleClass="p-datatable-gridlines p-datatable-sm shadow-md">
            
            <ng-template pTemplate="header">
                <tr>
                    <th class="w-1 text-center">Tipo Suspensión</th>
                    <th class="w-4 text-center">Descripción</th>
                    <th class="w-2 text-center">Fecha Inicio</th>
                    <th class="w-2 text-center">Fecha Fin</th>
                    <th class="w-1 text-center">Días No Trabajado</th>
                    <th class="w-1 text-center">Acciones</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-inasistencia let-rowIndex="rowIndex">
                <tr>
                    <td class="text-center">
                        <p-dropdown 
                            *ngIf="selectedInasistencia === inasistencia && isEditingInasistencia"
                            [options]="tipoSuspensionOptions" 
                            [(ngModel)]="inasistencia.pla03tiposuspension"
                            (click)="$event.stopPropagation()" optionLabel="name" 
                            optionValue="code"
                            (onChange)="onTipoSuspensionChange($event, inasistencia)"
                            placeholder="Tipo..."
                            appendTo="body"
                            [filter]="true"
                            styleClass="w-full text-sm">
                        </p-dropdown>
                        <span *ngIf="selectedInasistencia !== inasistencia || !isEditingInasistencia">
                            {{ inasistencia.pla03tiposuspension }}
                        </span>
                    </td>
                    
                    <td>
                        {{ inasistencia.glo02descripcion }}
                    </td>

                    <td class="text-center">
                        <p-calendar 
                            *ngIf="selectedInasistencia === inasistencia && isEditingInasistencia"
                            [(ngModel)]="inasistencia.pla03fechainicio" 
                            (ngModelChange)="updateDays(inasistencia)"
                            (click)="$event.stopPropagation()" dateFormat="dd/mm/yy" 
                            [showIcon]="true"
                            styleClass="w-full text-sm"
                            appendTo="body">
                        </p-calendar>
                        <span *ngIf="selectedInasistencia !== inasistencia || !isEditingInasistencia">
                            {{ inasistencia.pla03fechainicio | date: 'dd/MM/yyyy' }}
                        </span>
                    </td>

                    <td class="text-center">
                        <p-calendar 
                            *ngIf="selectedInasistencia === inasistencia && isEditingInasistencia"
                            [(ngModel)]="inasistencia.pla03fechafin" 
                            (ngModelChange)="updateDays(inasistencia)"
                            (click)="$event.stopPropagation()" dateFormat="dd/mm/yy" 
                            [showIcon]="true"
                            styleClass="w-full text-sm"
                            appendTo="body">
                        </p-calendar>
                        <span *ngIf="selectedInasistencia !== inasistencia || !isEditingInasistencia">
                            {{ inasistencia.pla03fechafin | date: 'dd/MM/yyyy' }}
                        </span>
                    </td>

                    <td class="text-center">
                        <p-inputNumber 
                            *ngIf="selectedInasistencia === inasistencia && isEditingInasistencia"
                            [(ngModel)]="inasistencia.pla03diasnotrabajados"
                            [disabled]="true"
                            mode="decimal"
                            [showButtons]="false"
                            styleClass="w-12 text-center"
                            inputStyleClass="text-center">
                        </p-inputNumber>
                        <span *ngIf="selectedInasistencia !== inasistencia || !isEditingInasistencia">
                            <p-badge [value]="inasistencia.pla03diasnotrabajados" severity="danger"></p-badge>
                        </span>
                    </td>

                    <td class="text-center">
                        <div *ngIf="selectedInasistencia === inasistencia && isEditingInasistencia" class="flex justify-center gap-1"
                             (click)="$event.stopPropagation()"> <button pButton pRipple icon="pi pi-check" class="p-button-success p-button-text p-button-sm" pTooltip="Guardar" (click)="saveInasistencia(inasistencia)"></button>
                            <button pButton pRipple icon="pi pi-times" class="p-button-danger p-button-text p-button-sm" pTooltip="Cancelar" (click)="cancelEditInasistencia(inasistencia, rowIndex)"></button>
                        </div>
                        
                        <div *ngIf="selectedInasistencia !== inasistencia && !isEditingInasistencia" class="flex justify-center gap-1"
                             (click)="$event.stopPropagation()"> <button pButton pRipple icon="pi pi-pencil" class="p-button-info p-button-text p-button-sm" pTooltip="Editar" (click)="editInasistencia(inasistencia)"></button>
                            <button pButton pRipple icon="pi pi-trash" class="p-button-danger p-button-text p-button-sm" pTooltip="Eliminar" (click)="deleteInasistencia(inasistencia)"></button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptyMessage">
                <tr>
                    <td colspan="6" class="text-center text-gray-500">No hay inasistencias registradas para este empleado.</td>
                </tr>
            </ng-template>

        </p-table>

    </div>

    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cerrar" icon="pi pi-times" (click)="displayInasistenciaDialog=false"
            class="p-button-secondary"></button>
    </ng-template>
</p-dialog>