<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<p-panel header="Asistencia de Personal" styleClass="shadow-xl rounded-lg">
    <div class="content-wrapper">
        <p-toolbar styleClass="mb-4 surface-200 border-round-lg shadow-1 align-to-table">
            <div class="flex justify-center gap-3">
                <button pButton pRipple icon="pi pi-trash" class="p-button-info p-button-sm" (click)="limpiarDias()"
                    pTooltip="Limpiar" tooltipPosition="bottom">
                </button>

                <button pButton pRipple icon="pi pi-save" class="p-button-info p-button-sm"
                    (click)="guardarTodosLosCambios()" pTooltip="Guardar" tooltipPosition="bottom">
                </button>

                <button pButton pRipple icon="pi pi-times" class="p-button-info p-button-sm" (click)="cerrarVista()"
                    pTooltip="Cancelar" tooltipPosition="bottom">
                </button>

                <!-- Botón Vista Previa -->
                <button pButton pRipple icon="pi pi-search" class="p-button-sm" (click)="vistaPreviaGeneral()"
                    pTooltip="Vista Previa" tooltipPosition="bottom">
                </button>
            </div>
            <div class="p-toolbar-group-start flex flex-wrap gap-3 ">
            </div>

            <div class="p-toolbar-group-end flex flex-wrap items-center space-x-2">
                <span class="text-sm font-semibold whitespace-nowrap px-2">Período Pago:</span>
                <p-dropdown [options]="periodoPagoOptions" [(ngModel)]="selectedPeriodoPago" optionLabel="label"
                    optionValue="value" placeholder="Seleccionar Período" styleClass="w-64" (onChange)="loadEmpleados()"
                    class="mr-2 dropdown-periodo-fijo">
                </p-dropdown>
            </div>
        </p-toolbar>

        <p-table #dt [value]="empleados" [paginator]="true" [rows]="rowsPerPage" [totalRecords]="totalDias"
            (onPage)="onPageChange($event)" dataKey="pla01empleadocod" [rowsPerPageOptions]="[5, 10, 20, 50]"
            [paginatorDropdownAppendTo]="'body'"
            styleClass="asistencia-table p-datatable-sm p-datatable-striped p-datatable-gridlines">

            <ng-template pTemplate="header">
                <tr>
                    <th style="width: auto;">Código</th>

                    <th style="width: auto;">
                        Nro. Identidad
                        <div class="mt-1 flex justify-content-center">
                            <p-columnFilter type="text" field="idIdentidad" matchMode="contains"
                                placeholder="Buscar Nro. Identidad" [showMenu]="false"
                                styleClass="p-inputtext-sm w-10rem">
                            </p-columnFilter>
                        </div>
                    </th>

                    <th style="width: auto;">
                        Apellidos y Nombres
                        <div class="mt-1 flex justify-content-center">
                            <p-columnFilter type="text" field="apellidosynombres" matchMode="contains"
                                placeholder="Buscar Personal" [showMenu]="false" styleClass="p-inputtext-sm w-full">
                            </p-columnFilter>
                        </div>
                    </th>

                    <th style="width: auto;">Fecha Ingreso</th>
                    <th style="width: auto;" class="text-center">Estado</th>
                    <th style="width: auto;" class="text-center">{{ getDynamicColumnLabel() }}</th>
                    <th style="width: auto;" class="text-center">Inasistencias</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-empleado>
                <tr>
                    <td class="text-center">{{ empleado.pla01empleadocod }}</td>
                    <td class="text-center">{{ empleado.idIdentidad }}</td>
                    <td class="text-center">{{ empleado.apellidosynombres }}</td>
                    <td class="text-center">{{ empleado.pla01fechaingreso | date: 'dd/MM/yyyy' }}</td>
                    <td class="text-center">{{ getEstadoLabel(empleado.pla01estado) }}</td>

                    <td class="w-24 text-center p-3">
                        <div class="flex justify-center w-full">
                            <input pInputText type="number" [min]="0" step="any" [max]="360"
                                class="w-14 border text-center border-gray-300 rounded input-dias-asistencia"
                                *ngIf="selectedPeriodoPago === 'UTILIDADES'" [(ngModel)]="empleado.pla02utilidad"
                                (ngModelChange)="empleado.pla02utilidad = $event > 360 ? 360 : $event < 0 ? 0 : $event" />

                            <input pInputText type="number" [min]="0" step="any" [max]="180"
                                class="w-14 border text-center border-gray-300 rounded input-dias-asistencia"
                                *ngIf="selectedPeriodoPago === 'GRATIFICACIONES'"
                                [(ngModel)]="empleado.pla02gratificacion"
                                (ngModelChange)="empleado.pla02gratificacion = $event > 180 ? 180 : $event < 0 ? 0 : $event" />
                        </div>
                    </td>

                    <td class="text-center">
                        <button pButton pRipple icon="pi pi-user"
                            class="p-button-rounded p-button-info p-button-text p-button-sm"
                            pTooltip="Ver/Registrar Inasistencias" (click)="openInasistenciaDialog(empleado)">
                        </button>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="9" class="text-center">No se encontraron empleados.</td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</p-panel>

<div *ngIf="!isMenuOpen" class="flex items-center justify-center h-screen -mt-20">
    <p-card header="Vista Cerrada" styleClass="shadow-lg bg-white">
        <p class="text-lg text-gray-700">La vista ha sido cerrada. Para volver a cargarla, presione el botón.</p>
        <button pButton label="Abrir Menú de Asistencia" icon="pi pi-folder-open" class="mt-4"
            (click)="isMenuOpen = true"></button>
    </p-card>
</div>


<p-dialog header="Inasistencia de Personal" [(visible)]="displayInasistenciaDialog" [modal]="true" [maximizable]="true"
    [style]="{ width: '80vw', minWidth: '400px' }" [draggable]="true" [resizable]="true">
    <div *ngIf="selectedInasistenciaEmpleado">
        <h3 class="text-lg font-semibold mb-3">Empleado: {{ selectedInasistenciaEmpleado.apellidosynombres }} ({{
            selectedInasistenciaEmpleado.pla01empleadocod }})</h3>

        <p-toolbar styleClass="mb-3 p-2 border-1 border-gray-200 rounded-md">
            <div class="p-toolbar-group-start">
                <button pButton pRipple icon="pi pi-plus" label="Nuevo" (click)="addInasistencia()"
                    [disabled]="isEditingInasistencia" class="p-button-info p-button-sm"></button>
            </div>
        </p-toolbar>

        <p-table [value]="inasistencias" [rowHover]="true" dataKey="pla03tiposuspension"
            [(selection)]="selectedInasistencia" selectionMode="single"
            styleClass="p-datatable-gridlines p-datatable-sm shadow-md">

            <ng-template pTemplate="header">
                <tr>
                    <th style="width: auto;">Tipo Suspensión</th>
                    <th style="width: auto;" class="text-center">Descripción</th>
                    <th style="width: auto;" class="text-center">Fecha Inicio</th>
                    <th style="width: auto;" class="text-center">Fecha Fin</th>
                    <th style="width: auto;" class="text-center">Días No Trabajado</th>
                    <th style="width: auto;" class="text-center">Acciones</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-inasistencia let-rowIndex="rowIndex">
                <tr>
                    <td class="text-center">
                        <p-dropdown *ngIf="selectedInasistencia === inasistencia && isEditingInasistencia"
                            [options]="tipoSuspensionOptions" [(ngModel)]="inasistencia.pla03tiposuspension"
                            (click)="$event.stopPropagation()" optionLabel="name" optionValue="code"
                            (onChange)="onTipoSuspensionChange($event, inasistencia)" placeholder="Tipo Suspensión"
                            appendTo="body" [filter]="true" styleClass="text-sm dropdown-inasistencia">
                        </p-dropdown>
                        <span *ngIf="selectedInasistencia !== inasistencia || !isEditingInasistencia">
                            {{ inasistencia.pla03tiposuspension }}
                        </span>
                    </td>

                    <td class="text-left">
                        <span
                            class="inline-block max-w-[200px] overflow-hidden text-ellipsis whitespace-nowrap align-middle">
                            {{ inasistencia.glo02descripcion }}
                        </span>
                    </td>

                    <td class="text-center">
                        <p-calendar *ngIf="selectedInasistencia === inasistencia && isEditingInasistencia"
                            [(ngModel)]="inasistencia.pla03fechainicio" (ngModelChange)="updateDays(inasistencia)"
                            (click)="$event.stopPropagation()" dateFormat="dd/mm/yy" [showIcon]="true"
                            styleClass="p-inputtext-sm w-10rem" appendTo="body">
                        </p-calendar>
                        <span *ngIf="selectedInasistencia !== inasistencia || !isEditingInasistencia">
                            {{ inasistencia.pla03fechainicio | date: 'dd/MM/yyyy' }}
                        </span>
                    </td>

                    <td class="text-center">
                        <p-calendar *ngIf="selectedInasistencia === inasistencia && isEditingInasistencia"
                            [(ngModel)]="inasistencia.pla03fechafin" (ngModelChange)="updateDays(inasistencia)"
                            (click)="$event.stopPropagation()" dateFormat="dd/mm/yy" [showIcon]="true"
                            styleClass="p-inputtext-sm w-10rem" appendTo="body">
                        </p-calendar>
                        <span *ngIf="selectedInasistencia !== inasistencia || !isEditingInasistencia">
                            {{ inasistencia.pla03fechafin | date: 'dd/MM/yyyy' }}
                        </span>
                    </td>

                    <td class="text-center">
                        <p-inputNumber *ngIf="selectedInasistencia === inasistencia && isEditingInasistencia"
                            [(ngModel)]="inasistencia.pla03diasnotrabajados" [disabled]="true" mode="decimal"
                            [showButtons]="false" styleClass="text-center" inputStyleClass="text-center">
                        </p-inputNumber>
                        <span *ngIf="selectedInasistencia !== inasistencia || !isEditingInasistencia">
                            <p-badge [value]="inasistencia.pla03diasnotrabajados" severity="danger"></p-badge>
                        </span>
                    </td>

                    <td class="text-center">
                        <div *ngIf="selectedInasistencia === inasistencia && isEditingInasistencia"
                            class="flex justify-content-between gap-1" (click)="$event.stopPropagation()">
                            <button pButton pRipple icon="pi pi-check"
                                class="p-button-success p-button-text p-button-sm" pTooltip="Guardar"
                                (click)="saveInasistencia(inasistencia)"></button>
                            <button pButton pRipple icon="pi pi-times" class="p-button-danger p-button-text p-button-sm"
                                pTooltip="Cancelar" (click)="cancelEditInasistencia(inasistencia, rowIndex)"></button>
                        </div>
                        
                        <div *ngIf="selectedInasistencia !== inasistencia && !isEditingInasistencia" 
                            class="flex justify-center gap-1" (click)="$event.stopPropagation()">
                            <button pButton pRipple icon="pi pi-pencil" class="p-button-info p-button-text p-button-sm"
                                pTooltip="Editar" (click)="editInasistencia(inasistencia)"></button>
                            <button pButton pRipple icon="pi pi-trash" class="p-button-danger p-button-text p-button-sm"
                                pTooltip="Eliminar" (click)="deleteInasistencia(inasistencia)"></button>
                        </div>
                    </td>
                </tr>
            </ng-template>
            
            <ng-template pTemplate="emptyMessage">
                <tr>
                    <td colspan="6" class="text-center text-gray-500">No hay inasistencias registradas para este
                        empleado.</td>
                </tr>
            </ng-template>

        </p-table>

    </div>
</p-dialog>

<p-dialog [(visible)]="displayReporteDialog" [modal]="true" [style]="{width: '1000px', 'max-height': '90vh'}"
    [maximizable]="true" [draggable]="false" [resizable]="false" header="Vista Previa">

    <div class="p-4 bg-white text-900 print-section">
        <!-- Cabecera del Reporte -->
        <div class="flex justify-content-between align-items-start mb-5">
            <div class="text-sm font-bold line-height-3">
                <div><span class="inline-block w-6rem">EMPRESA</span>: {{reporteData.empresa}}</div>
                <div><span class="inline-block w-6rem">AÑO</span>: {{reporteData.anio}}</div>
            </div>
            <div class="text-center flex-grow-1">
                <h2 class="text-xl font-bold m-0">{{reporteData.titulo}}</h2>
                <div class="text-lg font-bold mt-1">{{reporteData.subtitulo}}</div>
            </div>
            <!-- Espaciador para equilibrar el flex -->
            <div class="w-12rem"></div>
        </div>

        <!-- Tabla del Reporte (Estilo similar a la imagen) -->
        <div class="border-1 border-900 surface-0">
            <!-- Encabezado Tabla -->
            <div class="grid grid-nogutter font-bold border-bottom-1 border-900 bg-gray-100 text-sm">
                <div class="col-2 p-2 border-right-1 border-900">Codigo</div>
                <div class="col-2 p-2 border-right-1 border-900">DNI</div>
                <div class="col-6 p-2 border-right-1 border-900">Apellidos y Nombres</div>
                <div class="col-2 p-2 text-center">{{reporteData.columnaDinamica}}</div>
            </div>

            <!-- Cuerpo Tabla -->
            <div *ngFor="let row of reporteData.rows"
                class="grid grid-nogutter text-sm border-bottom-1 border-900 last:border-none hover:surface-50">
                <div class="col-2 p-2 border-right-1 border-900">{{row.codigo}}</div>
                <div class="col-2 p-2 border-right-1 border-900">{{row.dni}}</div>
                <div class="col-6 p-2 border-right-1 border-900">{{row.nombres}}</div>
                <div class="col-2 p-2 text-center">{{row.valorDinamico}}</div>
            </div>

            <!-- Mensaje si no hay datos -->
            <div *ngIf="reporteData.rows.length === 0" class="p-3 text-center text-500 italic">
                No hay datos para mostrar en este reporte.
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton type="button" label="Imprimir" icon="pi pi-print" class="p-button-info" (click)="imprimir()"></button>
    </ng-template>
</p-dialog>