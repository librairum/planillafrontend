<p-toast></p-toast>
<p-confirmDialog [style]="{width: '50vw'}" [baseZIndex]="1000"></p-confirmDialog>

<p-panel header="Asistencia personal" styleClass="main-asistencia-panel py-2" *ngIf="isMenuOpen">

    <div class="periodo-select-row mb-4"> 
        <div class="p-field">
            <label for="periodoPago" class="block mb-1 text-sm font-bold text-gray-700">Periodo Pago:</label>
            <p-dropdown [options]="periodoPagoOptions" [(ngModel)]="selectedPeriodoPago" optionLabel="label"
                optionValue="value" placeholder="Seleccione un periodo" [style]="{'width':'200px'}"
                (onChange)="loadTrabajadores()" styleClass="p-inputtext-sm" appendTo="body">
            </p-dropdown>
        </div>
    </div>

    <p-toolbar styleClass="custom-toolbar"> 
        <ng-template pTemplate="left">
            <div class="toolbar-group"> 
                <button pButton pRipple icon="pi pi-save" class="p-button-success toolbar-button"
                    (click)="guardar()" pTooltip="Guardar Cambios"></button>
                <button pButton pRipple icon="pi pi-times" class="p-button-warning toolbar-button"
                    (click)="cancelar()" pTooltip="Cancelar y Cerrar Menú"></button>
                <button pButton pRipple icon="pi pi-trash" class="p-button-danger toolbar-button"
                    (click)="eliminar()" pTooltip="Eliminar Asistencia del Empleado Seleccionado"
                    [disabled]="!selectedTrabajador"></button>
                <button pButton pRipple icon="pi pi-eye" class="p-button-info toolbar-button"
                    (click)="vistaPrevia()" pTooltip="Vista Previa"></button>
            </div>
        </ng-template>
    </p-toolbar>
    
    <div class="table-pagination-header"> 
        <div class="flex align-items-center">
            <label for="rowsPerPageTable" class="text-sm font-semibold mr-2 text-gray-700">Filas por página:</label>
            <p-dropdown id="rowsPerPageTable" [options]="[10, 20, 40, 50]" [(ngModel)]="rowsPerPage" appendTo="body"
                placeholder="Sel." styleClass="p-button-sm w-full text-center rows-per-page-dropdown"></p-dropdown>
        </div>
    </div>

    <div class="table-container">
        <p-table #dt [value]="trabajadores" [rows]="rowsPerPage" 
            [globalFilterFields]="['pla01empleadocod', 'idIdentidad', 'apellidosynombres', 'pla01estado']" [filterDelay]="0"
            [(selection)]="selectedTrabajador" selectionMode="single" dataKey="pla01empleadocod"
            styleClass="p-datatable-gridlines p-datatable-sm w-full custom-table" responsiveLayout="scroll" [first]="first">
            
            <ng-template pTemplate="header">
                <tr>
                    <th class="header-cell" style="width: 2%; text-align: center;">Código</th>
                    <th class="header-cell" style="width: 2%; text-align: center;">IdentidadNro</th>
                    <th class="header-cell" style="width: 7%; text-align: center;">Apellidos y Nombres</th>
                    <th class="header-cell" style="width: 2%; text-align: center;">Fecha Ingreso</th>
                    <th class="header-cell" style="width: 1%; text-align: center;">Estado</th>

                    <th class="header-cell text-center" style="width: 2%;">
                        {{ getDynamicColumnLabel() }}
                    </th>
                    <th class="header-cell" style="width: 1%;">Acciones</th>
                </tr>
            </ng-template>
            
            <ng-template pTemplate="body" let-trabajador>
                <tr [pSelectableRow]="trabajador">
                    <td class="text-center">{{ trabajador.pla01empleadocod }}</td>
                    <td class="text-center">{{ trabajador.idIdentidad }}</td>
                    <td class="text-center">{{ trabajador.apellidosynombres }}</td>
                    <td class="text-center">{{ trabajador.pla01fechaingreso | date:'dd/MM/yyyy' }}</td>
                    
                    <td class="text-center">
                        {{ getEstadoLabel(trabajador.pla01estado) }}
                    </td>

                    <td class="text-center">
                        <ng-container *ngIf="selectedPeriodoPago === 'UTILIDADES'">
                            {{ trabajador.pla02utilidad }}
                        </ng-container>
                        <ng-container *ngIf="selectedPeriodoPago === 'GRATIFICACIONES'">
                            {{ trabajador.pla02gratificacion }}
                        </ng-container>
                    </td>

                    <td class="text-center">
                        <button pButton pRipple icon="pi pi-user" class="p-button-rounded p-button-secondary p-button-text p-button-sm"
                            pTooltip="Ver Detalles"></button>
                    </td>
                </tr>
            </ng-template>
            
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="7" class="text-center p-4 empty-message">No se encontraron trabajadores.</td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <p-paginator [rows]="rowsPerPage" [totalRecords]="totalRecords" [first]="first"
        (onPageChange)="onPageChange($event)" styleClass="custom-paginator-external"></p-paginator>

</p-panel>

<p-card header="Asistencia Personal" *ngIf="!isMenuOpen">
    <div class="text-center p-4">
        <p class="text-lg">La ventana de Asistencia ha sido cerrada por la acción de cancelar.</p>
        <button pButton label="Abrir Menú de Asistencia" icon="pi pi-folder-open" class="mt-4" (click)="isMenuOpen = true"></button>
    </div>
</p-card>