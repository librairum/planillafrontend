<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="p-1 py-5 max-h-screen">
  <div class="mb-2">
    <p-panel header="Trabajador" styleClass="shadow-xl rounded-xl mb-3">
      <div class="flex justify-content-between align-items-center mb-3">
        <button type="button" pButton icon="pi pi-plus" label="Nuevo Trabajador"
        (click)="nuevoTrabajador()"
        class="p-button-sm"></button>
        <div class="flex align-items-center">
          <label for="rowsPerPage" class="mr-2">Filas por página:</label>
          <p-dropdown id="rowsPerPage" [options]="[10, 20, 40]" [(ngModel)]="rowsPerPage" placeholder="Seleccionar" class="p-button-sm"></p-dropdown>
        </div>
      </div>

      <p-table
      [value]="trabajadorList"
      dataKey="pla01empresacod"
      [paginator]="true"
      [rows]="rowsPerPage"
      responsiveLayout="scroll"
      styleClass="p-datatable-sm p-datatable-striped p-datatable-gridlines">
        <!-- Cabecera-->
        <ng-template pTemplate="header">
          <tr>
            <th style="text-align: center; width: 10%;">Código</th>
            <th style="text-align: center; width: 10%;">Doc. Identidad</th>
            <th style="text-align: center; width: 15%;">Apellidos y Nombres</th>
            <th style="text-align: center; width: 15%;">Dirección</th>
            <th style="text-align: center; width: 10%;">Fec. Nac.</th>
            <th style="text-align: center; width: 10%;">Teléfono</th>
            <th style="text-align: center; width: 10%;">Fec. Ingreso</th>
            <th style="text-align: center; width: 10%;">Centro costo</th>
            <th style="text-align: center; width: 10%;">Acciones</th>
          </tr>
        </ng-template>
        <!-- Cuerpo -->
        <ng-template pTemplate="body" let-trabajador>
          <tr>
            <td>{{trabajador.pla01empleadocod}}</td>
            <td>{{trabajador.pla01docuidentidadnro}}</td>
            <td>{{trabajador.apellidosynombres}}</td>
            <td>{{trabajador.pla01direccion}}</td>
            <td>{{trabajador.pla01fechanacimiento | date: 'dd/MM/yyyy'}}</td>
            <td>{{trabajador.pla01telefono}}</td>
            <td>{{trabajador.pla01fechaingreso | date: 'dd/MM/yyyy'}}</td>
            <td>{{trabajador.pla01centrocosto}}</td>
            <td>
              <div class="flex justify-content-center gap-2">

                <!-- Botón Ver Detalle -->

                <button pButton
                type="button"
                icon="pi pi-eye"
                pTooltip="Ver Detalle"
                (click)="verTrabajador(trabajador)"
                class="p-button-rounded p-button-text p-button-sm"></button>

                <!-- Botón Editar -->
                <button pButton
                (click)="editarTrabajador(trabajador)"
                icon="pi pi-pencil"
                pTooltip="Editar"
                class="p-button-rounded p-button-text p-button-sm"
                ></button>

                <!-- Botón Eliminar -->
                <button pButton
                type="button"
                (click)="eliminarTrabajador(trabajador)"
                icon="pi pi-trash"
                pTooltip="Eliminar"
                class="p-button-rounded p-button-text p-button-sm p-button-danger"></button>

              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-panel>
  </div>

</div>

<!-- Diálogo de Detalle -->
<p-dialog
[(visible)]="displayDialog"
[header]="'Detalle del trabajador'"
[style]="{width: '95vw', height: '90vh'}"
[modal]="true"
[draggable]="false"
[resizable]="false"
[closable]="false">
  <form [formGroup]="trabajadorForm">
    <!-- Detalles superiores -->
    <div class="flex flex-column gap-3 mb-3">

      <!-- Fila 1 -->
      <div class="flex gap-3">

        <!-- Codigo -->
        <div class="flex-1">
          <label>Código</label>
          <input type="text" pInputText formControlName="pla01empleadocod" placeholder="Código" class="w-full" readonly label="Código"/>
        </div>

        <!-- Doc.Tipo -->
        <div class="flex-2">
          <label>Doc.Tipo</label>
          <div class="flex align-items-center gap-2">
            <input type="text" pInputText formControlName="pla01docuidentidadtipo" readonly maxlength="2" style="width: 60px;"/>
            <input type="text" pInputText formControlName="tipdocdesc" readonly class="w-full"/>
            <button pButton type="button" icon="pi pi-search" class="p-button-sm"
            [disabled]="esModoVisualizacion" (click)="abrirBusquedaTipoDocumento()"></button>
          </div>
        </div>

        <!-- Doc.Nro -->
        <div class="flex-1">
          <label>Doc.Nro :</label>
          <input type="text" pInputText formControlName="pla01docuidentidadnro" [disabled]="true" class="w-full" />
        </div>
      </div>

      <!-- Fila 2 -->
      <div class="flex gap-3">
        <!-- Apellido Paterno -->
        <div class="flex-1">
          <label>Ape.Paterno :</label>
          <input type="text" pInputText formControlName="pla01apepaterno" class="w-full" />
        </div>

        <!-- Apellido Materno -->
        <div class="flex-1">
          <label>Ape.Materno :</label>
          <input type="text" pInputText formControlName="pla01apematerno" class="w-full" />
        </div>

        <!-- Nombres -->
        <div class="flex-2">
          <label>Nombres :</label>
          <input type="text" pInputText formControlName="pla01nombre1" class="w-full" />
        </div>

        <!-- Fecha Nacimiento -->
        <div class="flex-1 mt-4">
          <label>Fec.Nac :</label>
          <p-calendar formControlName="pla01fechanacimiento" dateFormat="dd/mm/yy" class="w-full"></p-calendar>
        </div>

        <!-- Sexo -->
        <div class="flex-1">
          <label>Sexo :</label>
          <div class="flex gap-2" style="height: 2.5rem; display: flex; align-items: center;">
            <p-radioButton formControlName="pla01sexo" label="M" [value]="'M'"></p-radioButton>
            <p-radioButton formControlName="pla01sexo" label="F" [value]="'F'"></p-radioButton>
          </div>
        </div>

      </div>

      <!-- Fila 3 -->
      <div class="flex gap-3">

        <!-- Régimen Laboral -->
        <div class="flex-1">
          <label>Reg.Laboral :</label>
          <!--<input type="text" pInputText formControlName="pla01regimenlaboral" [disabled]="true" class="w-full" />-->
          <div class="flex align-items-center gap-2">
            <input type="text" pInputText formControlName="pla01trdatoslabregimenlaboral"
            readonly maxlength="2" style="width: 60px" />
            <input type="text" pInputText formControlName="labregimenlaboraldes"
            readonly class="w-full"/>
            <button pButton type="button" icon="pi pi-search" class="p-button-sm"
            [disabled]="esModoVisualizacion" (click)="abrirBusquedaRegLaboral()"></button>
          </div>
        </div>
      </div>
    </div>
  </form>

    <!-- Sección cambiante -->
    <p-tabView>

      <!-- Principales-->
      <p-tabPanel header="Principales">

        <div class="grid gap-3">

          <!-- Primera fila -->
          <div class="col-12">

            <!-- Tabla de Remuneraciones -->
            <p-table [value]="trabajadorForm.value.remuneraciones" editable="true" styleClass="p-datatable-sm">
              <!-- Cabecera -->
              <ng-template pTemplate="header">
                <tr>
                  <th>Concepto cod.</th>
                  <th>Concepto desc.</th>
                  <th>Importe</th>
                  <th>Acciones</th>
                </tr>
              </ng-template>

              <!-- Cuerpo -->
              <ng-template pTemplate="body" let-remuneracion let-ri="rowIndex">
                <tr>
                  <td>
                    <p-cellEditor>
                      <ng-template pTemplate="input">
                        <input type="text" pInputText [(ngModel)]="remuneracion.pla05conceptocod" />
                      </ng-template>
                      <ng-template pTemplate="output">
                        {{ remuneracion.pla05conceptocod }}
                      </ng-template>
                    </p-cellEditor>
                  </td>
                  <td>
                    <p-cellEditor>
                      <ng-template pTemplate="input">
                        <input type="text" pInputText [(ngModel)]="remuneracion.conceptodesc" />
                      </ng-template>
                      <ng-template pTemplate="output">
                        {{ remuneracion.conceptodesc }}
                      </ng-template>
                    </p-cellEditor>
                  </td>
                  <td>
                    <p-cellEditor>
                      <ng-template pTemplate="input">
                        <input type="number" pInputText [(ngModel)]="remuneracion.pla05importe" />
                      </ng-template>
                      <ng-template pTemplate="output">
                        {{ remuneracion.pla05importe | number: '1.2-2' }}
                      </ng-template>
                    </p-cellEditor>
                  </td>
                  <td>
                    <!--
                    <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text p-button-sm" (click)="onRowEditInit(remuneracion)"></button>
                    <button pButton icon="pi pi-check" class="p-button-rounded p-button-text p-button-sm p-button-success" (click)="onRowEditSave(remuneracion, ri)"></button>
                    <button pButton icon="pi pi-times" class="p-button-rounded p-button-text p-button-sm p-button-danger" (click)="onRowEditCancel(remuneracion, ri)"></button>
                    <button pButton icon="pi pi-trash" class="p-button-rounded p-button-text p-button-sm p-button-danger" (click)="eliminarRemuneracion(ri)"></button>
                  -->
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>

          <div class="col-12">
            <!-- Tabla de Regímenes Pensionarios -->
            <p-table [value]="regimenespensionarios.controls" editable="true" styleClass="p-datatable-sm">
              <!-- Cabecera -->
              <ng-template pTemplate="header">
                <tr>
                  <th>Código Régimen</th>
                  <th>Descripción Régimen</th>
                  <th>Número CUPSS</th>
                  <th>Fecha Inicio</th>
                  <th>Fecha Fin</th>
                  <th>Comisión Mixta</th>
                  <th>Acciones</th>
                </tr>
              </ng-template>

              <!-- Cuerpo -->
              <ng-template pTemplate="body" let-regimen let-ri="rowIndex">
                <tr [formGroup]="regimen">
                  <!-- Código Régimen -->
                  <td>
                    <input type="text" pInputText formControlName="pla31regpensionariocod" readonly class="cursor-pointer text-primary" />
                  </td>

                  <!-- Descripción Régimen -->
                  <td>
                    <input type="text" pInputText formControlName="desregpensionario" readonly />
                  </td>

                  <!-- Número CUPSS -->
                  <td>
                    <input type="text" pInputText formControlName="pla31regpensionariocupss" />
                  </td>

                  <!-- Fecha Inicio -->
                  <td>
                    <p-calendar formControlName="pla31fechaini" dateFormat="dd/mm/yy" class="w-full" [appendTo]="'body'"></p-calendar>
                  </td>

                  <!-- Fecha Fin -->
                  <td>
                    <p-calendar formControlName="pla31fechafin" dateFormat="dd/mm/yy" class="w-full" [appendTo]="'body'"></p-calendar>
                  </td>

                  <!-- Comisión Mixta -->
                  <td>
                    <p-checkbox formControlName="pla31flagcomisionmixta" [binary]="true" [trueValue]="1" [falseValue]="0"></p-checkbox>
                  </td>

                  <!-- Botones de acción -->
                  <td>

                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>

          <!-- Segunda fila, Periodos Laborales -->
          <div class="col-12">
            <app-periodos-laborales
              [periodoslaborales]="periodoslaborales"
              [esModoVisualizacion]="esModoVisualizacion">
            </app-periodos-laborales>
          </div>

        </div>



      </p-tabPanel>

      <!-- Empresa -->
      <p-tabPanel header="Empresa">
        <button pButton label="Verificar Datos" (click)="verificarDatosFormulario()"></button>

        <!-- No hay datos -->

      </p-tabPanel>

      <!-- Dirección -->
      <p-tabPanel header="Dirección">

        <!-- No hay datos -->

      </p-tabPanel>

      <!-- Derecho de habientes -->
      <p-tabPanel header="Derecho de habientes">

        <!-- No hay datos -->

      </p-tabPanel>

      <!-- Laborales -->
      <p-tabPanel header="Laborales">

      </p-tabPanel>

      <!-- Seguro social -->
      <p-tabPanel header="Seguro social">

      </p-tabPanel>

      <!-- Tributarios -->
      <p-tabPanel header="Tributarios">

      </p-tabPanel>


    </p-tabView>



  <ng-template pTemplate="footer">
    <button pButton type="button" [label]="esModoVisualizacion ? 'Cerrar' : 'Cancelar'" icon="pi pi-times"
    class="p-button-secondary" (click)="cerrarTrabajador()"></button>

    <button *ngIf="!esModoVisualizacion" pButton type="button" label="Guardar" icon="pi pi-check"
    class="p-button-success" (click)="guardarTrabajador()"></button>

  </ng-template>
</p-dialog>

<!-- Modal para seleccionar régimen laboral -->

<p-dialog [(visible)]="displayBusquedaRegLaboralDialog" [header]="'Búsqueda de Régimen Laboral'" [modal]="true"
    [style]="{width: '50vw'}" [draggable]="false" [closable]="false" [resizable]="false">
    <p-table [value]="regimenesLaborales" [paginator]="true"
    [rows]="5" [scrollable]="true" responsiveLayout="scroll" styleClass="p-datatable-sm p-datatable-striped p-datatable-gridlines">
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 30%;">Código</th>
          <th style="width: 70%;">Descripción</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-regimen>
        <tr [pSelectableRow]="regimen" (click)="seleccionarRegimenLaboral(regimen)" style="cursor: pointer">
          <td>{{ regimen.codigo }}</td>
          <td>{{ regimen.descripcion }}</td>
        </tr>
      </ng-template>
    </p-table>
    <ng-template pTemplate="footer">
      <button pButton type="button" label="Cancelar" icon="pi pi-times" class="p-button-secondary"
        (click)="displayBusquedaRegLaboralDialog = false"></button>
    </ng-template>
</p-dialog>
