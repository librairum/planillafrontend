<p-panel header="PERIODO PAGO" styleClass="shadow-xl rounded-xl py-2 header-large">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <div class="content-wrapper">

        <p-toolbar styleClass="mb-4 surface-200 border-round-lg shadow-1 align-to-table">
            <ng-template pTemplate="left">
                <div class="toolbar-group">
                    <button pButton type="button" icon="pi pi-plus" label="Nuevo" class="p-button-info toolbar-button"
                        (click)="agregar()" pTooltip="Agregar nuevo periodo" tooltipPosition="bottom"></button>
                </div>
            </ng-template>

            <ng-template pTemplate="right">
                <div class="toolbar-group flex align-items-center gap-3">

                    <button pButton type="button" icon="pi pi-refresh" class="p-button-info toolbar-button"
                        (click)="refrescar()" pTooltip="Refrescar lista" tooltipPosition="bottom"></button>

                    <button pButton type="button"
                        [icon]="selectedPeriodo?.pla01flagperiodocerrado === true ? 'pi pi-lock-open' : 'pi pi-lock'"
                        [label]="selectedPeriodo 
                                        ? (selectedPeriodo.pla01flagperiodocerrado ? 'Abrir Periodo' : 'Cerrar Periodo')
                                        : 'Abrir/Cerrar Periodo'" class="p-button-info toolbar-button-text"
                        (click)="togglePeriodoEstado()" [disabled]="!selectedPeriodo"
                        pTooltip="Cambiar estado del periodo" tooltipPosition="bottom"></button>
                </div>
            </ng-template>
        </p-toolbar>

        <!--<div class="table-controls-header flex justify-content-end align-items-center" style="padding: 0.8rem 1rem;">
            <div class="flex align-items-center px-2">
                <label for="rowsPerPageTable" style="margin-right: 0.5rem; font-weight: 600; font-size: 0.9rem;">Filas
                    por p치gina:</label>
                <p-dropdown id="rowsPerPageTable" [options]="[10, 20, 40, 50]" [(ngModel)]="rowsPerPage" appendTo="body"
                    placeholder="Seleccionar" styleClass="p-button-sm w-12 text-center"></p-dropdown>
            </div>
        </div>-->

        <div class="py-2">
            <p-table #dt [value]="periodos" [(selection)]="selectedPeriodo" selectionMode="single" [paginator]="true"
                [rows]="rowsPerPage" responsiveLayout="scroll" [showCurrentPageReport]="false" 
                [rowsPerPageOptions]="[5, 10, 20, 50]"  [paginatorDropdownAppendTo]="'body'"
                [tableStyle]="{ 'min-width': '100%' }"
                styleClass="p-datatable-sm p-datatable-striped p-datatable-gridlines">

                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: auto; text-align: center;">
                            Periodo
                        </th>
                        <th style="width: auto; text-align: center;">
                            Descripci칩n
                        </th>
                        <th style="width: auto; text-align: center;">
                            Fec.Inicio
                        </th>
                        <th style="width: auto; text-align: center;">
                            Fec.Final
                        </th>
                        <th style="width: auto; text-align: center;">
                            Calculado
                        </th>
                        <th style="width: auto; text-align: center;">
                            Flag Fin Mes
                        </th>
                        <th style="width: auto; text-align: center;">
                            Fec.Pago
                        </th>
                        <th style="width: auto; text-align: center;">
                            Estado
                        </th>
                        <th style="width: auto; text-align: center;">
                            Fec.Proceso
                        </th>
                        <th style="width: auto; text-align: center;">
                            Desc.SubTipo Planilla
                        </th>
                        <th style="width: auto; text-align: center;">
                            Tipo Cambio
                        </th>
                        <th style="width: auto; text-align: center;">
                            Acciones </th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-periodo>
                    <tr [pSelectableRow]="periodo" [class.selected-row]="selectedPeriodo === periodo">
                        <td class="text-center">{{ periodo.pla01periodocod }}</td>
                        <td class="text-center">{{ periodo.pla01descripcion }}</td>
                        <td class="text-center">{{ periodo.pla01fechainicio | date:'dd/MM/yyyy' }}</td>
                        <td class="text-center">{{ periodo.pla01fechafin | date:'dd/MM/yyyy' }}</td>

                        <td class="text-center">
                            {{ periodo.pla01flagperiodocalculado ? 'S' : 'N' }}
                        </td>

                        <td class="text-center">
                            {{ periodo.pla01flagfindemes ? 'SI' : 'NO' }}
                        </td>

                        <td class="text-center">{{ periodo.pla01fechapago | date:'dd/MM/yyyy' }}</td>

                        <td class="text-center">
                            <span
                                [ngClass]="{'status-closed': periodo.pla01flagperiodocerrado, 'status-active': !periodo.pla01flagperiodocerrado}">
                                {{ getPeriodoEstado(periodo.pla01flagperiodocerrado, periodo.Pla55Descripcion) }}
                            </span>
                        </td>

                        <td class="text-center">{{ periodo.pla01fechaproceso | date:'dd/MM/yyyy' }}</td>
                        <td class="text-center">{{ periodo.Pla55Descripcion }}</td>
                        <td class="text-center">{{ periodo.pla01tipocambio | number:'1.2-2' }}</td>

                        <td class="text-center action-buttons">
                            <button pButton type="button" icon="pi pi-pencil"
                                class="p-button-rounded p-button-info p-button-text p-button-sm mr-1"
                                (click)="onEdit(periodo)" pTooltip="Modificar periodo"
                                tooltipPosition="bottom"></button>

                            <button pButton type="button" icon="pi pi-trash"
                                class="p-button-rounded p-button-danger p-button-text p-button-sm mr-1"
                                (click)="onDelete(periodo)" pTooltip="Eliminar periodo"
                                tooltipPosition="bottom"></button>

                            <button pButton type="button" icon="pi pi-search"
                                class="p-button-rounded p-button-info p-button-text p-button-sm"
                                (click)="onView(periodo)" pTooltip="Ver detalles" tooltipPosition="bottom"></button>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="12" class="text-center empty-message">
                            <i class="pi pi-info-circle"></i>
                            <p>No se encontraron periodos</p>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>

    <p-dialog [(visible)]="displayDialog"
        [header]="isViewing ? 'Ver Periodo' : (isEditing ? 'Modificar Periodo' : 'Nuevo Periodo')" [modal]="true"
        [style]="{width: '700px'}" [draggable]="false" [resizable]="false" styleClass="custom-dialog">

        <div class="dialog-content p-fluid grid">

            <div class="field col-12 md:col-6">
                <label for="periodo" class="form-label">Periodo: <span class="required">*</span></label>
                <input id="periodo" type="text" pInputText [(ngModel)]="periodoForm.pla01periodocod"
                    [disabled]="isViewing || isEditing" placeholder="Ej: 202001" />
            </div>

            <div class="field col-12 md:col-6">
                <label for="fecIni" class="form-label">Fecha Inicio: <span class="required">*</span></label>
                <p-calendar id="fecIni" [(ngModel)]="periodoForm.pla01fechainicio" dateFormat="dd/mm/yy"
                    [showIcon]="true" [disabled]="isViewing" placeholder="dd/mm/yyyy" appendTo="body"></p-calendar>
            </div>

            <div class="field col-12 md:col-6">
                <label for="fecFin" class="form-label">Fecha Final: <span class="required">*</span></label>
                <p-calendar id="fecFin" [(ngModel)]="periodoForm.pla01fechafin" dateFormat="dd/mm/yy" [showIcon]="true"
                    [disabled]="isViewing" placeholder="dd/mm/yyyy" appendTo="body"></p-calendar>
            </div>

            <div class="field col-12 md:col-6">
                <label for="fecPago" class="form-label">Fecha Pago: <span class="required">*</span></label>
                <p-calendar id="fecPago" [(ngModel)]="periodoForm.pla01fechapago" dateFormat="dd/mm/yy"
                    [showIcon]="true" [disabled]="isViewing" placeholder="dd/mm/yyyy" appendTo="body"></p-calendar>
            </div>

            <div class="field col-12 md:col-6">
                <label for="estado" class="form-label">Estado: <span class="required">*</span></label>
                <p-dropdown id="estado" [(ngModel)]="periodoForm.pla01flagperiodocerrado" [options]="estadoOptions"
                    optionLabel="label" [disabled]="isViewing" optionValue="value" placeholder="Seleccione estado"
                    appendTo="body"></p-dropdown>
            </div>

            <div class="field col-12 md:col-6">
                <label for="tipoCambio" class="form-label">Tipo de Cambio:</label>
                <p-inputNumber id="tipoCambio" [(ngModel)]="periodoForm.pla01tipocambio" mode="decimal"
                    [minFractionDigits]="2" [maxFractionDigits]="2" placeholder="0.00"
                    [disabled]="isViewing"></p-inputNumber>
            </div>

            <div class="field col-12">
                <label for="desc" class="form-label">Descripci칩n:</label>
                <input id="desc" type="text" pInputText [(ngModel)]="periodoForm.pla01descripcion"
                    [disabled]="isViewing" placeholder="Ingrese descripci칩n" />
            </div>

            <div class="field col-12">
                <label for="subTipo" class="form-label">SubTipo Planilla:</label>
                <input id="subTipo" type="text" pInputText [(ngModel)]="periodoForm.Pla55Descripcion"
                    placeholder="Ej: Empleados" [disabled]="isViewing" />
            </div>

            <div class="field col-12 flex align-items-center justify-content-start gap-5">
                <div class="flex align-items-center">
                    <p-checkbox id="calculado" [(ngModel)]="periodoForm.pla01flagperiodocalculado" [binary]="true"
                        [disabled]="isViewing" inputId="calculado"></p-checkbox>
                    <label for="calculado" class="ml-2">Calculado</label>
                </div>

                <div class="flex align-items-center">
                    <p-checkbox id="flagFin" [(ngModel)]="periodoForm.pla01flagfindemes" [binary]="true"
                        inputId="flagFin" [disabled]="isViewing"></p-checkbox>
                    <label for="flagFin" class="ml-2">Fin de Mes</label>
                </div>
            </div>

        </div>

        <ng-template pTemplate="footer">
            <button pButton type="button" label="Guardar" (click)="guardarPeriodo()" *ngIf="!isViewing"
                class="p-button-sm"></button>
        </ng-template>
    </p-dialog>
</p-panel>