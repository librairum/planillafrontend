<div class="periodo-pago-container">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <div class="page-header">
        <div class="header-content">
            <i class="pi pi-calendar-plus header-icon" style="color: white;"></i>
            <h2 style="color: white;">Periodo Pago</h2>
        </div>
    </div>

    <div class="content-card">
        <p-toolbar styleClass="custom-toolbar">
            <ng-template pTemplate="left">
                <div class="toolbar-group">
                    <button pButton type="button" icon="pi pi-plus" class="p-button-success toolbar-button" (click)="agregar()"
                        pTooltip="Agregar nuevo periodo" tooltipPosition="bottom"></button>

                    <button pButton type="button" icon="pi pi-pencil" class="p-button-warning toolbar-button"
                        (click)="modificar()" [disabled]="!selectedPeriodo" pTooltip="Modificar periodo"
                        tooltipPosition="bottom"></button>

                    <button pButton type="button" icon="pi pi-trash" class="p-button-danger toolbar-button" (click)="eliminar()"
                        [disabled]="!selectedPeriodo" pTooltip="Eliminar periodo" tooltipPosition="bottom"></button>

                    <button pButton type="button" icon="pi pi-search" class="p-button-info toolbar-button" (click)="ver()"
                        [disabled]="!selectedPeriodo" pTooltip="Ver detalles del periodo" tooltipPosition="bottom"></button>

                    <button pButton type="button" icon="pi pi-refresh" class="p-button-secondary toolbar-button"
                        (click)="refrescar()" pTooltip="Refrescar datos" tooltipPosition="bottom"></button>
                </div>
            </ng-template>

            <ng-template pTemplate="right">
                <div class="toolbar-group flex align-items-center gap-3">
                    <button pButton type="button" icon="pi pi-lock-open" label="Abrir Periodo"
                        class="p-button-help toolbar-button-text" (click)="abrirPeriodo()"
                        [disabled]="!selectedPeriodo || !selectedPeriodo.pla01flagperiodocerrado"
                        pTooltip="Abrir periodo seleccionado" tooltipPosition="bottom"></button>

                    <button pButton type="button" icon="pi pi-lock" label="Cerrar Periodo"
                        class="p-button-danger toolbar-button-text" (click)="cerrarPeriodo()"
                        [disabled]="!selectedPeriodo || selectedPeriodo.pla01flagperiodocerrado"
                        pTooltip="Cerrar periodo seleccionado" tooltipPosition="bottom"></button>
                </div>
            </ng-template>
        </p-toolbar>

        <div class="table-controls-header flex justify-content-end align-items-center"
            style="padding: 0.8rem 1rem; border-top: 1px solid #dee2e6;">
            <div class="flex align-items-center px-2">
                <label for="rowsPerPageTable" style="margin-right: 0.5rem; font-weight: 600; font-size: 0.9rem;">Filas por p치gina:</label>
                <p-dropdown id="rowsPerPageTable" [options]="[10, 20, 40, 50]" [(ngModel)]="rowsPerPage" appendTo="body"
                    placeholder="Seleccionar" styleClass="p-button-sm w-12 text-center"></p-dropdown>
            </div>
        </div>

        <div class="table-container py-2">
            <p-table #dt [value]="periodos" [(selection)]="selectedPeriodo" selectionMode="single" [paginator]="true"
                [rows]="rowsPerPage" responsiveLayout="scroll" [showCurrentPageReport]="false"
                [globalFilterFields]="['pla01periodocod', 'pla01descripcion', 'Pla55Descripcion']"
                [tableStyle]="{ 'min-width': '100%' }" styleClass="p-datatable-striped p-datatable-gridlines">

                <ng-template pTemplate="header">
                    <tr>
                        <th style="text-align: center;" pSortableColumn="pla01periodocod">
                            Periodo
                        </th>
                        <th style="width: 20%; text-align: center;" pSortableColumn="pla01descripcion">
                            Descripci칩n
                        </th>
                        <th style="text-align: center;" pSortableColumn="pla01fechainicio">
                            Fec.Inicio
                        </th>
                        <th style="text-align: center;" pSortableColumn="pla01fechafin">
                            Fec.Final
                        </th>
                        <th style="text-align: center;" pSortableColumn="pla01flagperiodocalculado">
                            Calculado
                        </th>
                        <th style="text-align: center;" pSortableColumn="pla01flagfindemes">
                            Flag Fin Mes
                        </th>
                        <th style="text-align: center;" pSortableColumn="pla01fechapago">
                            Fec.Pago
                        </th>
                        <th style="text-align: center;" pSortableColumn="pla01flagperiodocerrado">
                            Estado
                        </th>
                        <th style="text-align: center;" pSortableColumn="pla01fechaproceso">
                            Fec.Proceso
                        </th>
                        <th style="text-align: center;" pSortableColumn="Pla55Descripcion">
                            Desc.SubTipo Planilla
                        </th>
                        <th style="text-align: center;" pSortableColumn="pla01tipocambio">
                            Tipo Cambio
                        </th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-periodo>
                    <tr [pSelectableRow]="periodo" [class.selected-row]="selectedPeriodo === periodo">
                        <td class="text-center">{{ periodo.pla01periodocod }}</td>
                        <td class="text-center">{{ periodo.pla01descripcion }}</td>
                        <td class="text-center">{{ periodo.pla01fechainicio | date:'dd/MM/yyyy' }}</td>
                        <td class="text-center">{{ periodo.pla01fechafin | date:'dd/MM/yyyy' }}</td>

                        <td class="text-center">
                            {{ periodo.pla01flagperiodocalculado ? 'S' : 'N' }}
                        </td>

                        <td class="text-center">
                            {{ periodo.pla01flagfindemes ? 'SI' : 'NO' }}
                        </td>

                        <td class="text-center">{{ periodo.pla01fechapago | date:'dd/MM/yyyy' }}</td>

                        <td class="text-center">
                            <span [ngClass]="{'status-closed': periodo.pla01flagperiodocerrado, 'status-active': !periodo.pla01flagperiodocerrado}">
                                {{ getPeriodoEstado(periodo.pla01flagperiodocerrado, periodo.Pla55Descripcion) }}
                            </span>
                        </td>

                        <td class="text-center">{{ periodo.pla01fechaproceso | date:'dd/MM/yyyy' }}</td>
                        <td class="text-center">{{ periodo.Pla55Descripcion }}</td>
                        <td class="text-center">{{ periodo.pla01tipocambio | number:'1.2-2' }}</td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="11" class="text-center empty-message">
                            <i class="pi pi-info-circle"></i>
                            <p>No se encontraron periodos</p>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>

    <p-dialog [(visible)]="displayDialog"
        [header]="isViewing ? 'Ver Periodo' : (isEditing ? 'Modificar Periodo' : 'Nuevo Periodo')"
        [modal]="true" [style]="{width: '800px'}" [draggable]="false" [resizable]="false" styleClass="custom-dialog">

        <div class="dialog-content">
            <div class="form-grid">
                <div class="form-field">
                    <label for="periodo" class="form-label">Periodo: <span class="required">*</span></label>
                    <input id="periodo" type="text" pInputText [(ngModel)]="periodoForm.pla01periodocod" [disabled]="isViewing || isEditing"
                        class="w-full" placeholder="Ej: 202001" />
                </div>

                <div class="form-field full-width">
                    <label for="desc" class="form-label">Descripci칩n:</label>
                    <input id="desc" type="text" pInputText [(ngModel)]="periodoForm.pla01descripcion" class="w-full"
                        [disabled]="isViewing" placeholder="Ingrese descripci칩n" />
                </div>

                <div class="form-field">
                    <label for="fecIni" class="form-label">Fecha Inicio: <span class="required">*</span></label>
                    <p-calendar id="fecIni" [(ngModel)]="periodoForm.pla01fechainicio" dateFormat="dd/mm/yy" [showIcon]="true"
                        [disabled]="isViewing" inputStyleClass="w-full" styleClass="w-full" placeholder="dd/mm/yyyy" appendTo="body"></p-calendar>
                </div>

                <div class="form-field">
                    <label for="fecFin" class="form-label">Fecha Final: <span class="required">*</span></label>
                    <p-calendar id="fecFin" [(ngModel)]="periodoForm.pla01fechafin" dateFormat="dd/mm/yy" [showIcon]="true"
                        [disabled]="isViewing" inputStyleClass="w-full" styleClass="w-full" placeholder="dd/mm/yyyy" appendTo="body"></p-calendar>
                </div>

                <div class="form-field">
                    <label for="fecPago" class="form-label">Fecha Pago: <span class="required">*</span></label>
                    <p-calendar id="fecPago" [(ngModel)]="periodoForm.pla01fechapago" dateFormat="dd/mm/yy" [showIcon]="true"
                        [disabled]="isViewing" inputStyleClass="w-full" styleClass="w-full" placeholder="dd/mm/yyyy" appendTo="body"></p-calendar>
                </div>

                <div class="form-field">
                    <label for="estado" class="form-label">Estado: <span class="required">*</span></label>
                    <p-dropdown id="estado" [(ngModel)]="periodoForm.pla01flagperiodocerrado" [options]="estadoOptions" optionLabel="label"
                        [disabled]="isViewing" optionValue="value" placeholder="Seleccione estado" styleClass="w-full" appendTo="body"></p-dropdown>
                </div>

                <div class="form-field">
                    <label for="tipoCambio" class="form-label">Tipo de Cambio:</label>
                    <input id="tipoCambio" type="number" pInputText [(ngModel)]="periodoForm.pla01tipocambio" class="w-full"
                        step="0.01" placeholder="0.00" [disabled]="isViewing" />
                </div>

                <div class="form-field">
                    <label for="subTipo" class="form-label">SubTipo Planilla:</label>
                    <input id="subTipo" type="text" pInputText [(ngModel)]="periodoForm.Pla55Descripcion" class="w-full"
                        placeholder="Ej: Empleados" [disabled]="isViewing" />
                </div>

                <div class="form-field checkbox-container" style="width: 750px;">
                    <div class="checkbox-item">
                        <p-checkbox id="calculado" [(ngModel)]="periodoForm.pla01flagperiodocalculado" [binary]="true"
                            [disabled]="isViewing" inputId="calculado"></p-checkbox>
                        <label for="calculado" class="checkbox-label">Calculado</label>

                        <p-checkbox id="flagFin" [(ngModel)]="periodoForm.pla01flagfindemes" [binary]="true"
                            inputId="flagFin" [disabled]="isViewing"></p-checkbox>
                        <label for="flagFin" class="checkbox-label">Fin de Mes</label>
                    </div>
                </div>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <button pButton type="button" label="{{isViewing ? 'Cerrar' : 'Cancelar'}}" icon="pi pi-times"
                class="p-button-secondary p-button-outlined"
                (click)="displayDialog = false; isViewing = false"></button>

            <button pButton type="button" label="Guardar" icon="pi pi-check"
                (click)="guardarPeriodo()" *ngIf="!isViewing"></button>
        </ng-template>
    </p-dialog>
</div>