<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="container">
    <p-panel header="Concepto" class="mb-3">
        <!--<p-breadcrumb [model]="items" class="max-w-full"></p-breadcrumb>-->
    </p-panel>
    <br />
    <div class="card">
        <!-- Botón Nuevo y Dropdown Filas por Página -->
        <div class="flex justify-content-between align-items-center mb-3">
            <button type="button" pButton icon="pi pi-plus" label="Nuevo Concepto"
                    (click)="showAddRow()" [disabled]="isEditingAnyRow"
                    class="p-button-sm"></button>
            <div class="flex align-items-center">
                <label for="rowsPerPage" class="mr-2">Filas por página:</label>
                <p-dropdown id="rowsPerPage" [options]="[10, 20, 40]" [(ngModel)]="rowsPerPage" placeholder="Seleccionar" class="p-button-sm"></p-dropdown>
            </div>
        </div>

        <!-- Tabla Principal -->
        <p-table [value]="conceptoList"
                 dataKey="pla10conceptocod"
                 editMode="row"
                 [paginator]="true"
                 [rows]="rowsPerPage"
                 responsiveLayout="scroll"
                 styleClass="p-datatable-sm">

            <!-- Cabecera de Tabla -->
            <ng-template pTemplate="header">
                <tr>
                    <th style="text-align: center; width: 10%;">Código</th>
                    <th style="text-align: center; width: 30%;">Descripción</th>
                    <th style="text-align: center; width: 15%;">TipoFlagEstandar</th>
                    <th style="text-align: center; width: 10%;">Activo</th>
                    <th style="text-align: center; width: 15%;">ConceptoTipoDesc</th>
                    <th style="text-align: center; width: 10%;">Concept.Padre</th>
                    <th style="text-align: center; width: 10%;">Acciones</th>
                </tr>
            </ng-template>

            <!-- Cuerpo de Tabla -->
            <ng-template pTemplate="body" let-concepto let-ri="rowIndex" let-editing="editing">
                <tr [pEditableRow]="concepto">

                    <td>
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <input pInputText type="text" [(ngModel)]="concepto.pla10conceptocod"
                                       class="p-inputtext-sm w-full" required>
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{concepto.pla10conceptocod}}
                            </ng-template>
                        </p-cellEditor>
                    </td>

                    <td>
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <input pInputText type="text" [(ngModel)]="concepto.pla10conceptodesc"
                                       class="p-inputtext-sm w-full" required>
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{concepto.pla10conceptodesc}}
                            </ng-template>
                        </p-cellEditor>
                    </td>

                    <td>
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <input pInputText type="text" [(ngModel)]="concepto.pla10flagestandardesc"
                                       class="p-inputtext-sm w-full" required>
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{concepto.pla10flagestandardesc}}
                            </ng-template>
                        </p-cellEditor>
                    </td>

                    <td>
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <input pInputText type="text" [(ngModel)]="concepto.pla10flagactivo"
                                       class="p-inputtext-sm w-full" required>
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{concepto.pla10flagactivo}}
                            </ng-template>
                        </p-cellEditor>
                    </td>

                    <td>
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <input pInputText type="text" [(ngModel)]="concepto.conceptotipodesc"
                                       class="p-inputtext-sm w-full" required>
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{concepto.conceptotipodesc}}
                            </ng-template>
                        </p-cellEditor>
                    </td>

                    <td style="text-align: center;">
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <input pInputText type="text" [(ngModel)]="concepto.pla10conceptopadrecod"
                                       class="p-inputtext-sm w-full" required>
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{concepto.pla10conceptopadrecod}}
                            </ng-template>
                        </p-cellEditor>
                    </td>


                    <!-- Acciones -->
                    <td>
                        <div class="flex justify-content-center gap-2">

                            <!-- Botón de Ayuda-->

                            <button *ngIf="!editing" pButton
                                    type="button"
                                    icon="pi pi-question-circle"
                                    pTooltip="Ayuda"
                                    class="p-button-rounded p-button-text p-button-sm"
                                    (click)="mostrarAyuda(concepto)"></button>

                            <!-- Botón Ver Detalle -->

                            <button *ngIf="!editing" pButton
                                    type="button"
                                    icon="pi pi-eye"
                                    pTooltip="Ver Detalle"
                                    (click)="showDetalle(concepto)"
                                    class="p-button-rounded p-button-text p-button-sm"></button>

                            <!-- Botón Editar -->
                            <button *ngIf="!editing" pButton
                                    pInitEditableRow
                                    (click)="onRowEditInit(concepto)"
                                    icon="pi pi-pencil"
                                    pTooltip="Editar"
                                    [disabled]="isNew || isEditingAnyRow"
                                    class="p-button-rounded p-button-text p-button-sm"
                                    ></button>

                            <!-- Botón Guardar -->
                            <button *ngIf="editing" pButton
                                    pSaveEditableRow
                                    (click)="onRowEditSave(concepto)"
                                    icon="pi pi-check"
                                    pTooltip="Guardar"
                                    class="p-button-rounded p-button-text p-button-sm p-button-success"></button>

                            <!-- Botón Cancelar -->
                            <button *ngIf="editing" pButton
                                    pCancelEditableRow
                                    (click)="onRowEditCancel(concepto, ri)"
                                    icon="pi pi-times"
                                    pTooltip="Cancelar"
                                    class="p-button-rounded p-button-text p-button-sm p-button-danger"></button>

                            <!-- Botón Eliminar
                            Se pasaba tambien el parametro ri en onDelete,
                            pero no es necesario ya que se puede identificar con el objeto regimen
                            -->
                            <button *ngIf="!editing" pButton
                                    type="button"
                                    (click)="onDelete(concepto)"
                                    icon="pi pi-trash"
                                    pTooltip="Eliminar"
                                    [disabled]="isNew || isEditingAnyRow"
                                    class="p-button-rounded p-button-text p-button-sm p-button-danger"></button>

                        </div>
                    </td>
                </tr>
            </ng-template>

            <!-- Footer para Nuevo Registro -->
            <ng-template pTemplate="footer">
                <tr *ngIf="isEditing">
                    <td colspan="9">
                        <form [formGroup]="conceptoForm" class="grid p-fluid">
                            <div class="col-1" style="width: 10%;">
                                <span class="w-full">
                                    <input pInputText
                                          formControlName="pla61codigo"
                                          placeholder="Código"
                                          class="p-inputtext-sm w-full"
                                          readonly/>
                                </span>
                            </div>

                            <div class="col-1" style="width: 15%;">
                                <span class="w-full">
                                    <input pInputText
                                           formControlName="pla61descripcion"
                                           placeholder="Descripción"
                                           class="p-inputtext-sm w-full"/>
                                </span>
                            </div>

                            <div class="col-1" style="width: 15%;">
                                <span class="w-full">
                                    <p-dropdown
                                        formControlName="pla61tiporegpensionariocod"
                                        [options]="[
                                            { label: 'Otros Regimenes Pensionarios', value: 'ORP' },
                                            { label: 'Sistema Nacional de Pensiones', value: 'SNP' },
                                            { label: 'Sistema Privado de Pensiones', value: 'SPP' }
                                        ]"
                                        placeholder="Tipo de régimen"
                                        optionLabel="label"
                                        optionValue="value"
                                        class="p-inputtext-sm w-full"
                                        appendTo="body">
                                    </p-dropdown>
                                </span>
                            </div>

                            <div class="col-1" style="width: 10%;">
                                <span class="w-full">
                                    <input pInputText
                                           formControlName="pla61afpnetcod"
                                           placeholder="AFPNet"
                                           class="p-inputtext-sm w-full"/>
                                </span>
                            </div>

                            <div class="col-1" style="width: 15%;">
                                <span class="w-full">
                                    <p-dropdown
                                        formControlName="pla61plamecod"
                                        [options]="[
                                            { label: 'DL 19990 - SIST NAC DE PENS - ONP', value: '02' },
                                            { label: 'SPP INTEGRA', value: '21' }
                                        ]"
                                        placeholder="Plame"
                                        optionLabel="label"
                                        optionValue="value"
                                        class="p-inputtext-sm w-full"
                                        appendTo="body">
                                    </p-dropdown>
                                </span>
                            </div>

                            <div class="col-1" style="text-align: center; width: 10%;">
                              <p-checkbox formControlName="pla61flagsectorprivado" [binary]="true"></p-checkbox>
                            </div>

                            <div class="col-1" style="text-align: center; width: 10%;">
                              <p-checkbox formControlName="pla61flagsectorpublico" [binary]="true"></p-checkbox>
                            </div>

                            <div class="col-1" style="text-align: center; width: 5%;">
                              <p-checkbox formControlName="pla61flagactivo" [binary]="true"></p-checkbox>
                            </div>

                            <!-- Botones de Acción -->
                            <div class="col-1" style="width: 10%;">
                                <div class="flex gap-2 justify-content-center">

                                    <p-button icon="pi pi-check" styleClass="p-button-success p-button-sm" [text]="true"
                                            (onClick)="onSave()" pTooltip="Guardar"></p-button>
                                    <p-button icon="pi pi-times" styleClass="p-button-danger p-button-sm" [text]="true"
                                            (onClick)="onCancel()" pTooltip="Cancelar"></p-button>
                                </div>
                            </div>
                        </form>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<!-- Diálogo de Detalle -->
<p-dialog
  [(visible)]="displayDialog"
  [header]="'Detalle de concepto'"
  [style]="{width: '95vw', height: '90vh'}"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [closable]="false">
  <form [formGroup]="conceptoForm">
    <div class="concepto-detalle">
      <div class="info-basica">

        <!-- Código y descripción -->
        <div class="form-row flex gap-3 mb-3 align-items-center">

          <div class="form-group flex-2">
            <label>Código :</label>
            <input type="text" pInputText formControlName="pla10conceptocod"
            [disabled]="!isNewRecord || esModoVisualizacion" maxlength="10"
            class="w-full"/>
          </div>

          <div class="form-group flex-1">
            <label>Descripción :</label>
            <input type="text" pInputText formControlName="pla10conceptodesc"
            [disabled]="esModoVisualizacion" maxlength="150"
            class="w-full"/>
          </div>

        </div>

        <!-- Tipos -->
        <div class="form-row flex gap-3 mb-3 align-items-center">

          <div class="form-group flex-1">
            <label>Tipo cálculo :</label>
            <div class="flex gap-2 align-items-center">
              <input type="text" pInputText formControlName="pla10tipocalculocod"
              readonly maxlength="2" style="width: 60px" />
              <input type="text" pInputText formControlName="calculotipodesc"
              class="w-full"/>
              <button pButton type="button" icon="pi pi-search" class="p-button-sm"
              [disabled]="esModoVisualizacion" (click)="abrirBusquedaTipoCalculo()"></button>
            </div>
          </div>

          <div class="form-group flex-1">
            <label>Tipo :</label>
            <div class="flex gap-2 align-items-center">
              <input type="text" pInputText formControlName="pla10tipoconceptocod"
              readonly maxlength="2" style="width: 60px" />
              <input type="text" pInputText formControlName="pla10conceptodesc"
              class="w-full"/>
              <button pButton type="button" icon="pi pi-search" class="p-button-sm"
              [disabled]="esModoVisualizacion" (click)="abrirBusquedaConceptoTipo()"></button>
              </div>
          </div>

          <div class="form-group flex-1">
            <label>Sub Tipo :</label>
            <div class="flex gap-2 align-items-center">
              <input type="text" pInputText formControlName="pla10subtipoconceptocod"
              readonly maxlength="2" style="width: 60px" />
              <input type="text" pInputText formControlName="conceptosubtipodesc"
              class="w-full"/>
              <button pButton type="button" icon="pi pi-search" class="p-button-sm"
              [disabled]="esModoVisualizacion" (click)="abrirBusquedaSubTipo()"></button>
            </div>
          </div>

        </div>

        <!-- Checkboxes -->
        <div class="flex gap-4 mb-3 align-items-center">

          <p-checkbox formControlName="pla10flagimpresion"
          [binary]="true" label="Imprimible"
          [disabled]="esModoVisualizacion" inputId="imprimible"></p-checkbox>

          <p-checkbox formControlName="pla10flagconfigurable"
          [binary]="true" label="Config.Basica"
          [disabled]="esModoVisualizacion" inputId="configBasica"></p-checkbox>

          <p-checkbox formControlName="pla10flagclase"
          [binary]="true" label="Formulable"
          [disabled]="esModoVisualizacion" inputId="formulable"></p-checkbox>

          <p-checkbox formControlName="pla10flagactivo"
          [binary]="true" label="Activo"
          [disabled]="esModoVisualizacion" inputId="activo"></p-checkbox>

        </div>

      </div>

      <!-- Text Areas -->
      <div class="flex gap-4 mb-3">
        <textarea pInputTextarea rows="8" formControlName="pla10formula" class="w-full"></textarea>
        <textarea pInputTextarea rows="8" formControlName="pla10formulaalias" class="w-full"></textarea>
      </div>

      <!-- Concepto Sunat y Observacion -->
      <div class="flex gap-4 mb-3">
        <div class="flex-1">
          <label>Concepto Sunat :</label>
          <div class="flex gap-2 align-items-center">
            <input type="text" pInputText formControlName="pla10conceptosunatcod"
              readonly style="width: 100px" />
            <input type="text" pInputText formControlName="conceptosunatdesc"
            style="flex: 1" />
            <button pButton type="button" icon="pi pi-search" class="p-button-sm"
            [disabled]="esModoVisualizacion" (click)="abrirBusquedaConceptoSunat()"></button>
          </div>
        </div>

        <div class="flex-1">
          <label>Observación</label>
          <textarea pInputTextarea rows="3" formControlName="pla10comentario"
          [disabled]="esModoVisualizacion" class="w-full"></textarea>
        </div>
      </div>

      <!-- Tablas Relacionadas -->
      <div class="flex gap-3 mt-3">

        <!-- Afectaciones Sunat -->
        <div class="flex-1">
          <h4 class="mb-2">Afectaciones Sunat</h4>
          <p-table
          [value]="conceptoActual.afectacionesSunat"
          [scrollable]="true"
          scrollHeight="200px">
            <ng-template pTemplate="header">
              <tr>
                <th style="text-align: center; width: 20%;">Código</th>
                <th style="text-align: center; width: 60%;">Descripción</th>
                <th style="text-align: center; width: 20%;">Valor</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
              <tr>
                <td>{{ item.codigo }}</td>
                <td>{{ item.descripcion }}</td>
                <td class="text-center">
                  <!-- Standalone es necesario para evitar conflictos con el formulario -->
                  <p-checkbox
                  [(ngModel)]="item.valor"
                  [ngModelOptions]="{standalone: true}"
                  [binary]="true"
                  [disabled]="esModoVisualizacion"></p-checkbox>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>

        <div class="flex-1">
          <h4 class="mb-2">Afectación Otros</h4>
          <p-table
          [value]="conceptoActual.afectacionOtros"
          [scrollable]="true"
          scrollHeight="200px">
            <ng-template pTemplate="header">
              <tr>
                <th style="text-align: center; width: 20%;">Código</th>
                <th style="text-align: center; width: 60%;">Descripción</th>
                <th style="text-align: center; width: 20%;">Valor</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
              <tr>
                <td>{{ item.codigo }}</td>
                <td>{{ item.descripcion }}</td>
                <td class="text-center">
                  <!-- Standalone es necesario para evitar conflictos con el formulario -->
                  <p-checkbox
                  [(ngModel)]="item.valor"
                  [ngModelOptions]="{standalone: true}"
                  [binary]="true"
                  [disabled]="esModoVisualizacion"></p-checkbox>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>

        <div class="flex-1">
          <h4 class="mb-2">Plantilla Asignada</h4>
          <p-table
          [value]="conceptoActual.planillasAsignadas"
          [scrollable]="true"
          scrollHeight="200px">
            <ng-template pTemplate="header">
              <tr>
                <th style="text-align: center; width: 20%;">Código</th>
                <th style="text-align: center; width: 60%;">Descripción</th>
                <th style="text-align: center; width: 20%;">Valor</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
              <tr>
                <td>{{ item.codigo }}</td>
                <td>{{ item.descripcion }}</td>
                <td class="text-center">
                  <!-- Standalone es necesario para evitar conflictos con el formulario -->
                  <p-checkbox
                  [(ngModel)]="item.valor"
                  [ngModelOptions]="{standalone: true}"
                  [binary]="true"
                  [disabled]="esModoVisualizacion"></p-checkbox>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>

        <div class="flex-1">
          <h4 class="mb-2">Régimen Laboral</h4>
          <p-table
          [value]="conceptoActual.regimenesLaborales"
          [scrollable]="true"
          scrollHeight="200px">
            <ng-template pTemplate="header">
              <tr>
                <th style="text-align: center; width: 20%;">Código</th>
                <th style="text-align: center; width: 60%;">Descripción</th>
                <th style="text-align: center; width: 20%;">Valor</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
              <tr>
                <td>{{ item.codigo }}</td>
                <td>{{ item.descripcion }}</td>
                <td class="text-center">
                  <!-- Standalone es necesario para evitar conflictos con el formulario -->
                  <p-checkbox
                  [(ngModel)]="item.valor"
                  [ngModelOptions]="{standalone: true}"
                  [binary]="true"
                  [disabled]="esModoVisualizacion"></p-checkbox>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>

      </div>

    </div>


  </form>
  <ng-template pTemplate="footer">
    <button pButton type="button" label="Cerrar" icon="pi pi-times"
    (click)="cerrarDetalle()" class="p-button-text"></button>

  </ng-template>
</p-dialog>
