<div class="usuarios-container">
  <p-toast></p-toast>
  
  <p-confirmDialog></p-confirmDialog>

  <div class="page-header">
    <div class="header-content">
      <span class="header-title">Usuarios</span>
      <button pButton type="button" 
              icon="pi pi-plus" 
              class="p-button-sm add-button"
              (click)="agregarNuevo()"
              pTooltip="Agregar nuevo usuario"
              tooltipPosition="bottom"></button>
    </div>
  </div>

  <div class="table-wrapper">
    <p-table 
      [value]="usuarios" 
      [paginator]="true"
      [rows]="5"
      [rowsPerPageOptions]="[5, 10, 20]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} usuarios"
      selectionMode="single" 
      [(selection)]="selectedUsuario" 
      (onRowSelect)="onUsuarioSelect($event)"
      dataKey="id"
      styleClass="usuarios-table">
      
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 150px">Id</th>
          <th style="width: 300px">Nombre</th>
          <th style="width: 150px">Clave</th>
          <th>Perfil</th>
          <th style="width: 200px; text-align: center">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-usuario let-rowIndex="rowIndex">
        <tr [pSelectableRow]="usuario" [pSelectableRowDisabled]="usuario.isEditing">
          <td>
            <input 
              *ngIf="usuario.isEditing" 
              type="text" 
              pInputText 
              [(ngModel)]="usuario.id"
              [disabled]="!usuario.isNew"
              class="table-input"
              maxlength="20" />
            <span *ngIf="!usuario.isEditing">{{ usuario.id }}</span>
          </td>

          <td>
            <input 
              *ngIf="usuario.isEditing" 
              type="text" 
              pInputText 
              [(ngModel)]="usuario.nombre"
              class="table-input"
              maxlength="100" />
            <span *ngIf="!usuario.isEditing">{{ usuario.nombre }}</span>
          </td>

          <td>
            <p-password 
              *ngIf="usuario.isEditing"
              [(ngModel)]="usuario.clave"
              [feedback]="false"
              [style]="{'width': '100%'}"
              inputStyleClass="table-input"
              promptLabel="Ingrese clave"
              weakLabel="Débil"
              mediumLabel="Media"
              strongLabel="Fuerte">
            </p-password>
            <span *ngIf="!usuario.isEditing">********</span>
          </td>

          <td>
            <p-dropdown 
              *ngIf="usuario.isEditing"
              [options]="perfiles" 
              [(ngModel)]="usuario.perfil"
              optionLabel="label"
              optionValue="value"
              placeholder="Seleccione perfil"
              [style]="{'width': '100%'}"
              styleClass="table-dropdown">
            </p-dropdown>
            <span *ngIf="!usuario.isEditing">{{ usuario.perfil }}</span>
          </td>

          <td class="actions-cell">
            <div class="action-buttons">
              <button *ngIf="!usuario.isEditing"
                pButton type="button" icon="pi pi-pencil" 
                class="p-button-rounded p-button-text p-button-sm p-button-warning"
                (click)="editar(usuario)"
                pTooltip="Editar" tooltipPosition="top">
              </button>

              <button *ngIf="!usuario.isEditing"
                pButton type="button" icon="pi pi-trash" 
                class="p-button-rounded p-button-text p-button-sm p-button-danger"
                (click)="eliminar(usuario, rowIndex)"
                pTooltip="Eliminar" tooltipPosition="top">
              </button>

              <button *ngIf="usuario.isEditing"
                pButton type="button" icon="pi pi-undo" 
                class="p-button-rounded p-button-text p-button-sm p-button-secondary"
                (click)="cancelar(usuario, rowIndex)"
                pTooltip="Cancelar" tooltipPosition="top">
              </button>

              <button *ngIf="usuario.isEditing"
                pButton type="button" icon="pi pi-save" 
                class="p-button-rounded p-button-text p-button-sm p-button-success"
                (click)="guardar(usuario, rowIndex)"
                pTooltip="Guardar" tooltipPosition="top">
              </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center empty-message">No se encontraron usuarios</td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <h3 class="detail-title">Empresas por usuario</h3>

  <div class="table-wrapper">
    <p-table 
      [value]="empresasUsuario" 
      [paginator]="true"
      [rows]="5"
      [tableStyle]="{ 'min-width': '100%' }">
      
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 100px">Empresa</th>
          <th style="width: 300px">Razón Social</th>
          <th style="width: 150px">Ruc</th>
          <th>Dirección</th>
          <th style="width: 120px; text-align: center">FlagEstado</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-empresa>
        <tr>
          <td>{{ empresa.empresaCod }}</td>
          <td>{{ empresa.razonSocial }}</td>
          <td>{{ empresa.ruc }}</td>
          <td>{{ empresa.direccion }}</td>
          <td style="text-align: center;">
            <p-checkbox [(ngModel)]="empresa.flagEstado" [binary]="true"></p-checkbox>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center empty-message">
            <i class="pi pi-info-circle"></i>
            <p *ngIf="selectedUsuario">No se encontraron empresas para este usuario</p>
            <p *ngIf="!selectedUsuario">Seleccione un usuario para ver sus empresas</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>